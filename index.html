<!DOCTYPE html>
<html lang="en" class="light">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
   <meta name="version" content="1.3.6">

   <!-- PWA Meta Tags -->
   <meta name="theme-color" content="#111827">
   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <meta name="apple-mobile-web-app-title" content="Live Beats">
   
   <!-- Manifest -->
   <link rel="manifest" href="manifest.json" crossorigin="use-credentials">

   <!-- Icons - All paths made relative for GitHub Pages -->
   <link rel="shortcut icon" href="icons/icon-32.png">
   <link rel="icon" href="icons/icon-32.png" sizes="32x32">
   <link rel="icon" href="icons/icon-192.png" sizes="192x192">
   <link rel="apple-touch-icon" href="icons/icon-180.png">
   <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">

   <!-- Windows-specific tags -->
   <meta name="msapplication-TileImage" content="icons/icon-144.png">
   <meta name="msapplication-TileColor" content="#111827">
   <meta name="msapplication-config" content="browserconfig.xml">

<title>Live Beats WebRadio Player</title>
    
<button id="installButton" 
        class="hidden fixed bottom-32 right-4 z-[60] bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-200 flex items-center animate-pulse"
        aria-label="Install Live Beats App">
  <i class="fas fa-download mr-2"></i> Install
</button>
    
    <script src="https://cdn.tailwindcss.com"></script>
   <script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: {
            50: '#f0f9ff',
            100: '#e0f2fe',
            200: '#bae6fd',
            300: '#7dd3fc',
            400: '#38bdf8',
            500: '#0ea5e9',
            600: '#0284c7',
            700: '#0369a1',
            800: '#075985',
            900: '#0c4a6e',
          },
          // Add new theme colors
          rose: {
            50: '#fff1f2',
            100: '#ffe4e6',
            200: '#fecdd3',
            300: '#fda4af',
            400: '#fb7185',
            500: '#f43f5e',
            600: '#e11d48',
            700: '#be123c',
            800: '#9f1239',
            900: '#881337',
          },
          pink: {
            50: '#fdf2f8',
            100: '#fce7f3',
            200: '#fbcfe8',
            300: '#f9a8d4',
            400: '#f472b6',
            500: '#ec4899',
            600: '#db2777',
            700: '#be185d',
            800: '#9d174d',
            900: '#831843',
          },
          fuchsia: {
            50: '#fdf4ff',
            100: '#fae8ff',
            200: '#f5d0fe',
            300: '#f0abfc',
            400: '#e879f9',
            500: '#d946ef',
            600: '#c026d3',
            700: '#a21caf',
            800: '#86198f',
            900: '#701a75',
          },
          purple: {
            50: '#faf5ff',
            100: '#f3e8ff',
            200: '#e9d5ff',
            300: '#d8b4fe',
            400: '#c084fc',
            500: '#a855f7',
            600: '#9333ea',
            700: '#7e22ce',
            800: '#6b21a8',
            900: '#581c87',
          },
          violet: {
            50: '#f5f3ff',
            100: '#ede9fe',
            200: '#ddd6fe',
            300: '#c4b5fd',
            400: '#a78bfa',
            500: '#8b5cf6',
            600: '#7c3aed',
            700: '#6d28d9',
            800: '#5b21b6',
            900: '#4c1d95',
          },
          indigo: {
            50: '#eef2ff',
            100: '#e0e7ff',
            200: '#c7d2fe',
            300: '#a5b4fc',
            400: '#818cf8',
            500: '#6366f1',
            600: '#4f46e5',
            700: '#4338ca',
            800: '#3730a3',
            900: '#312e81',
          },
          blue: {
            50: '#eff6ff',
            100: '#dbeafe',
            200: '#bfdbfe',
            300: '#93c5fd',
            400: '#60a5fa',
            500: '#3b82f6',
            600: '#2563eb',
            700: '#1d4ed8',
            800: '#1e40af',
            900: '#1e3a8a',
          },
          sky: {
            50: '#f0f9ff',
            100: '#e0f2fe',
            200: '#bae6fd',
            300: '#7dd3fc',
            400: '#38bdf8',
            500: '#0ea5e9',
            600: '#0284c7',
            700: '#0369a1',
            800: '#075985',
            900: '#0c4a6e',
          },
          cyan: {
            50: '#ecfeff',
            100: '#cffafe',
            200: '#a5f3fc',
            300: '#67e8f9',
            400: '#22d3ee',
            500: '#06b6d4',
            600: '#0891b2',
            700: '#0e7490',
            800: '#155e75',
            900: '#164e63',
          },
          teal: {
            50: '#f0fdfa',
            100: '#ccfbf1',
            200: '#99f6e4',
            300: '#5eead4',
            400: '#2dd4bf',
            500: '#14b8a6',
            600: '#0d9488',
            700: '#0f766e',
            800: '#115e59',
            900: '#134e4a',
          },
          emerald: {
            50: '#ecfdf5',
            100: '#d1fae5',
            200: '#a7f3d0',
            300: '#6ee7b7',
            400: '#34d399',
            500: '#10b981',
            600: '#059669',
            700: '#047857',
            800: '#065f46',
            900: '#064e3b',
          },
          green: {
            50: '#f0fdf4',
            100: '#dcfce7',
            200: '#bbf7d0',
            300: '#86efac',
            400: '#4ade80',
            500: '#22c55e',
            600: '#16a34a',
            700: '#15803d',
            800: '#166534',
            900: '#14532d',
          },
          lime: {
            50: '#f7fee7',
            100: '#ecfccb',
            200: '#d9f99d',
            300: '#bef264',
            400: '#a3e635',
            500: '#84cc16',
            600: '#65a30d',
            700: '#4d7c0f',
            800: '#3f6212',
            900: '#365314',
          },
          yellow: {
            50: '#fefce8',
            100: '#fef9c3',
            200: '#fef08a',
            300: '#fde047',
            400: '#facc15',
            500: '#eab308',
            600: '#ca8a04',
            700: '#a16207',
            800: '#854d0e',
            900: '#713f12',
          },
          amber: {
            50: '#fffbeb',
            100: '#fef3c7',
            200: '#fde68a',
            300: '#fcd34d',
            400: '#fbbf24',
            500: '#f59e0b',
            600: '#d97706',
            700: '#b45309',
            800: '#92400e',
            900: '#78350f',
          },
          orange: {
            50: '#fff7ed',
            100: '#ffedd5',
            200: '#fed7aa',
            300: '#fdba74',
            400: '#fb923c',
            500: '#f97316',
            600: '#ea580c',
            700: '#c2410c',
            800: '#9a3412',
            900: '#7c2d12',
          },
          red: {
            50: '#fef2f2',
            100: '#fee2e2',
            200: '#fecaca',
            300: '#fca5a5',
            400: '#f87171',
            500: '#ef4444',
            600: '#dc2626',
            700: '#b91c1c',
            800: '#991b1b',
            900: '#7f1d1d',
          },
          warmGray: {
            50: '#fafaf9',
            100: '#f5f5f4',
            200: '#e7e5e4',
            300: '#d6d3d1',
            400: '#a8a29e',
            500: '#78716c',
            600: '#57534e',
            700: '#44403c',
            800: '#292524',
            900: '#1c1917',
          },
          trueGray: {
            50: '#fafafa',
            100: '#f5f5f5',
            200: '#e5e5e5',
            300: '#d4d4d4',
            400: '#a3a3a3',
            500: '#737373',
            600: '#525252',
            700: '#404040',
            800: '#262626',
            900: '#171717',
          },
          gray: {
            50: '#f9fafb',
            100: '#f3f4f6',
            200: '#e5e7eb',
            300: '#d1d5db',
            400: '#9ca3af',
            500: '#6b7280',
            600: '#4b5563',
            700: '#374151',
            800: '#1f2937',
            900: '#111827',
          },
          coolGray: {
            50: '#f9fafb',
            100: '#f3f4f6',
            200: '#e5e7eb',
            300: '#d1d5db',
            400: '#9ca3af',
            500: '#6b7280',
            600: '#4b5563',
            700: '#374151',
            800: '#1f2937',
            900: '#111827',
          },
          blueGray: {
            50: '#f8fafc',
            100: '#f1f5f9',
            200: '#e2e8f0',
            300: '#cbd5e1',
            400: '#94a3b8',
            500: '#64748b',
            600: '#475569',
            700: '#334155',
            800: '#1e293b',
            900: '#0f172a',
          },
        },
        fontFamily: {
          sans: ['Inter', 'sans-serif'],
        },
        animation: {
          'spin-slow': 'spin 3s linear infinite',
          'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
        }
      }
    }
  }
</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.8);
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: rgba(75, 85, 99, 0.5);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(75, 85, 99, 0.8);
        }

        /* Player controls fixed at bottom */
        .player-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.8);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark .player-controls {
            background-color: rgba(17, 24, 39, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal styles */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal.open .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal .modal-content {
            transform: translateY(20px) scale(0.98);
            opacity: 0;
        }

        /* Input focus states */
        input:focus, textarea:focus, select:focus, button:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        .dark input:focus, .dark textarea:focus, .dark select:focus, .dark button:focus-visible {
            outline-color: #60a5fa;
        }


/* Share Modal Styles */
#favoritesToShare {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
}

.dark #favoritesToShare {
    scrollbar-color: rgba(75, 85, 99, 0.5) transparent;
}

#favoritesToShare::-webkit-scrollbar {
    width: 6px;
}

#favoritesToShare::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
}

.dark #favoritesToShare::-webkit-scrollbar-thumb {
    background-color: rgba(75, 85, 99, 0.5);
}

       

        /* Button styles & hover effects */
        .btn {
            @apply font-medium py-2.5 px-5 rounded-lg shadow-sm transition-all duration-200 ease-in-out transform focus:outline-none;
        }
        .btn-primary {
            @apply btn bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white hover:shadow-md hover:scale-[1.02];
        }
        .btn-secondary {
            @apply btn bg-gray-100 hover:bg-gray-200 text-gray-800 hover:shadow-md hover:scale-[1.02] border border-gray-200;
        }
        .dark .btn-secondary {
            @apply bg-gray-700 hover:bg-gray-600 text-gray-200 border-gray-600;
        }
        
        .btn-danger {
            @apply btn bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .btn-success {
            @apply btn bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .btn-warning {
            @apply btn bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .icon-btn {
            @apply p-2.5 sm:p-3 rounded-full transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none;
        }
        .icon-btn:hover {
            @apply bg-gray-100 dark:bg-gray-700;
        }
        .icon-btn:focus-visible {
            @apply ring-2 ring-offset-1 ring-blue-500 dark:ring-blue-400;
        }

        /* Message Box */
        #messageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #messageBox.opacity-0 {
            transform: translateY(-20px);
        }
        #messageBox.opacity-100 {
            transform: translateY(0);
        }
        
        /* Station card hover effect */
        .station-card {
            @apply transition-all duration-200 ease-in-out transform hover:-translate-y-0.5;
        }
        
        /* Volume slider */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            @apply bg-gray-200 dark:bg-gray-600;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            @apply bg-blue-500 dark:bg-blue-400 cursor-pointer;
        }
        
        /* Loading spinner */
        .spinner {
            animation: spin-slow 1.5s linear infinite;
        }
        
        /* Now playing animation */
        @keyframes nowPlaying {
            0%, 100% { opacity: 0.5; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        .now-playing {
            animation: nowPlaying 2s ease-in-out infinite;
        }
        
        /* Gradient text */
        .gradient-text {
            @apply bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400;
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Pulse animation for live indicator */
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .live-indicator {
            animation: livePulse 2s ease-in-out infinite;
        }
        
        /* Waveform animation */
        .waveform {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 40px;
            height: 20px;
        }
        
        .waveform-bar {
            background-color: currentColor;
            width: 3px;
            border-radius: 3px;
            animation: waveformAnimation 1.5s ease-in-out infinite;
        }
        
        .waveform-bar:nth-child(1) {
            height: 30%;
            animation-delay: 0.1s;
        }
        
        .waveform-bar:nth-child(2) {
            height: 60%;
            animation-delay: 0.3s;
        }
        
        .waveform-bar:nth-child(3) {
            height: 40%;
            animation-delay: 0.5s;
        }
        
        .waveform-bar:nth-child(4) {
            height: 80%;
            animation-delay: 0.2s;
        }
        
        .waveform-bar:nth-child(5) {
            height: 50%;
            animation-delay: 0.4s;
        }
        
        @keyframes waveformAnimation {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.2); }
        }

           /* Radio Browser Styles */
#radioBrowserResults::-webkit-scrollbar {
    width: 6px;
}

#radioBrowserResults {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
}

.dark #radioBrowserResults {
    scrollbar-color: rgba(75, 85, 99, 0.5) transparent;
}

.popular-tag-btn {
    transition: all 0.2s ease;
}

.popular-tag-btn:hover {
    transform: translateY(-1px);
}

           .station-card {
        cursor: pointer;
    }

    [onclick="toggleSection('playFromUrlSection')"], 
    [onclick="toggleSection('discoverStationsSection')"] {
        cursor: pointer;
    }
  /* Color Theme Classes */
        .theme-rose { --color-primary-500: #f43f5e; --color-primary-600: #e11d48; }
        .theme-pink { --color-primary-500: #ec4899; --color-primary-600: #db2777; }
        .theme-fuchsia { --color-primary-500: #d946ef; --color-primary-600: #c026d3; }
        .theme-purple { --color-primary-500: #a855f7; --color-primary-600: #9333ea; }
        .theme-violet { --color-primary-500: #8b5cf6; --color-primary-600: #7c3aed; }
        .theme-indigo { --color-primary-500: #6366f1; --color-primary-600: #4f46e5; }
        .theme-blue { --color-primary-500: #3b82f6; --color-primary-600: #2563eb; }
        .theme-sky { --color-primary-500: #0ea5e9; --color-primary-600: #0284c7; }
        .theme-cyan { --color-primary-500: #06b6d4; --color-primary-600: #0891b2; }
        .theme-teal { --color-primary-500: #14b8a6; --color-primary-600: #0d9488; }
        .theme-emerald { --color-primary-500: #10b981; --color-primary-600: #059669; }
        .theme-green { --color-primary-500: #22c55e; --color-primary-600: #16a34a; }
        .theme-lime { --color-primary-500: #84cc16; --color-primary-600: #65a30d; }
        .theme-yellow { --color-primary-500: #eab308; --color-primary-600: #ca8a04; }
        .theme-amber { --color-primary-500: #f59e0b; --color-primary-600: #d97706; }
        .theme-orange { --color-primary-500: #f97316; --color-primary-600: #ea580c; }
        .theme-red { --color-primary-500: #ef4444; --color-primary-600: #dc2626; }
        .theme-warmGray { --color-primary-500: #78716c; --color-primary-600: #57534e; }
        .theme-trueGray { --color-primary-500: #737373; --color-primary-600: #525252; }
        .theme-gray { --color-primary-500: #6b7280; --color-primary-600: #4b5563; }
        .theme-coolGray { --color-primary-500: #6b7280; --color-primary-600: #4b5563; }
        .theme-blueGray { --color-primary-500: #64748b; --color-primary-600: #475569; }

        /* Primary color variables */
        :root {
          --color-primary-500: #3b82f6; /* Default blue-500 */
          --color-primary-600: #2563eb; /* Default blue-600 */
        }

        /* Update elements using primary colors */
        .btn-primary {
          background-color: var(--color-primary-500);
          border-color: var(--color-primary-600);
        }

        .btn-primary:hover {
          background-color: var(--color-primary-600);
        }

        .gradient-text {
          background-image: linear-gradient(to right, var(--color-primary-500), var(--color-primary-600));
        }
        /* ===== END OF COLOR THEMES ===== */
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

    <audio id="audioPlayer"></audio>

    <header class="bg-white dark:bg-gray-800 shadow-sm p-4 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center max-w-6xl px-4">
            <div class="flex items-center space-x-2">
               <img src="icons/icon-48.png" 
     alt="Live Beats Icon" 
     class="w-8 h-8 rounded-lg">
                <h1 class="text-xl sm:text-2xl font-bold gradient-text">
                    Live Beats WebRadio
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="themePaletteBtn" class="icon-btn text-gray-600 dark:text-gray-300" aria-label="Theme options">
    <i class="fas fa-palette"></i>
</button>
                
                <button id="infoBtn" class="icon-btn text-gray-600 dark:text-gray-300" aria-label="App Info">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-6xl p-4 flex-grow mb-36">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Play from URL section -->
             <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between p-5 cursor-pointer" onclick="toggleSection('playFromUrlSection')">
        <h2 class="text-xl font-semibold flex items-center">
            <i class="fas fa-link mr-2 text-blue-500"></i>
            Play from URL
        </h2>
        <button class="icon-btn text-gray-500 dark:text-gray-400">
            <i id="playFromUrlToggleIcon" class="fas fa-plus"></i>
        </button>
    </div>
    <div id="playFromUrlSection" class="px-5 pb-5 hidden">
        <div class="flex flex-col sm:flex-row items-stretch gap-3">
            <input type="url" id="directUrlInput" 
                   class="flex-grow w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                   placeholder="https://example.com/stream.mp3">
            <button id="playDirectUrlBtn" class="btn-primary whitespace-nowrap">
                <i class="fas fa-play mr-2"></i>Play
            </button>
        </div>
        <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
            Tip: If the station will not play it likely doesn't support CORS
        </div>
    </div>
</div>

               <!-- Radio Browser section -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between p-5 cursor-pointer" onclick="toggleSection('discoverStationsSection')">
        <h2 class="text-xl font-semibold flex items-center">
            <i class="fas fa-search mr-2 text-blue-500"></i>
            Discover Stations
        </h2>
        <button class="icon-btn text-gray-500 dark:text-gray-400">
            <i id="discoverStationsToggleIcon" class="fas fa-plus"></i>
        </button>
    </div>
    <div id="discoverStationsSection" class="px-5 pb-5 hidden">
        <div class="flex flex-col sm:flex-row items-stretch gap-3 mb-4">
            <input type="text" id="radioSearchInput" 
                   class="flex-grow w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                   placeholder="Search for stations...">
            <button id="radioSearchBtn" class="btn-primary whitespace-nowrap">
                <i class="fas fa-search mr-2"></i>Search
            </button>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-4">
            <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="topclick">Popular</button>
            <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="topvote">Top Rated</button>
            <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="genre">By Genre</button>
        </div>
        
        <div id="radioBrowserResults" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 hidden">
            <!-- Results will be displayed here -->
        </div>
        
        <div id="radioBrowserLoading" class="text-center py-4 hidden">
            <i class="fas fa-spinner spinner text-blue-500 text-2xl"></i>
            <p class="text-gray-500 dark:text-gray-400 mt-2">Loading stations...</p>
        </div>
        
        <div id="radioBrowserEmpty" class="text-center py-4">
            <i class="fas fa-radio text-3xl text-gray-300 dark:text-gray-600 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">Search for radio stations to discover</p>
        </div>
    </div>
</div>
                
                <!-- Quick Access section -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-bolt mr-2 text-amber-500"></i>
                            Quick Access
                        </h2>
                        <button id="editQuickAccessBtn" class="icon-btn text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div id="quickAccessList" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Quick access buttons will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Right column -->
            <div class="space-y-6">
               <!-- Actions section -->
<div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
    <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class="fas fa-cog mr-2 text-gray-500"></i>
        Actions
    </h2>
    <div class="grid grid-cols-2 gap-3">
        <button id="openAddModalBtn" class="btn-primary">
            <i class="fas fa-plus mr-2"></i>Add Fav
        </button>
        <button id="importFavoritesBtn" class="btn-warning">
            <i class="fas fa-file-import mr-2"></i>Import
        </button>
        <button id="exportFavoritesBtn" class="btn-success">
            <i class="fas fa-file-export mr-2"></i>Export
        </button>
        <button id="clearFavoritesBtn" class="btn-danger">
            <i class="fas fa-trash mr-2"></i>Clear
        </button>
        <button id="shareBtn" class="btn-secondary">
            <i class="fas fa-share-alt mr-2"></i>Share
        </button>
        <button id="refreshBtn" class="btn-secondary">
            <i class="fas fa-sync-alt mr-2"></i>Refresh
        </button>
    </div>
</div>
                
                <!-- Now Playing section -->
                <div id="nowPlayingSection" class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hidden">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-headphones mr-2 text-purple-500"></i>
                        Now Playing
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                                <i class="fas fa-music text-2xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">Station</p>
                            <p id="currentStationName" class="font-bold truncate" title="No station selected">---</p>
                            <div class="flex items-center mt-1">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 mr-2">
                                    <span class="w-2 h-2 rounded-full bg-red-500 mr-1 live-indicator"></span>
                                    LIVE
                                </span>
                                <span id="bitrateInfo" class="text-xs text-gray-500 dark:text-gray-400"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Favorites section -->
        <div class="mt-6 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    My Favorite Stations
                </h2>
                <span id="favoritesCount" class="text-sm bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-2.5 py-0.5 rounded-full">
                    0 stations
                </span>
            </div>
            
            <div id="favoritesList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                <div id="noFavoritesMsg" class="text-center py-8">
                    <i class="fas fa-radio text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">No favorite stations yet.</p>
                    <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Add some stations or try the quick access links!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Player controls -->
    <div class="player-controls">
        <div class="container mx-auto max-w-6xl flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0 p-4">
            <div class="w-full sm:w-auto flex items-center space-x-3 text-center sm:text-left mb-2 sm:mb-0 min-w-0">
                <div class="flex-grow min-w-0">
                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 truncate">Now Playing:</p>
                    <p id="currentStationNameCompact" class="font-semibold truncate text-base sm:text-lg" title="No station selected">---</p>
                </div>
                <button id="addCurrentToFavoritesBtn" class="icon-btn text-yellow-500 dark:text-yellow-400 hidden text-lg" title="Add current station to favorites" aria-label="Add to favorites">
                    <i class="fas fa-star"></i>
                </button>
            </div>

            <div class="flex items-center space-x-4">
                <button id="stopBtn" class="icon-btn text-2xl sm:text-3xl text-red-500 dark:text-red-400" aria-label="Stop">
                    <i class="fas fa-stop"></i>
                </button>
            <button id="playPauseBtn" class="icon-btn text-3xl sm:text-4xl text-green-500 hover:text-green-600 dark:text-green-400 dark:hover:text-green-300" aria-label="Play">
    <i class="fas fa-play"></i>
</button>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-down text-gray-600 dark:text-gray-300 text-base sm:text-lg"></i>
                   <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5" 
       class="w-32 sm:w-40 h-2 bg-gray-200 dark:bg-gray-600 rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-blue-500 dark:[&::-webkit-slider-thumb]:bg-blue-400">
                    <i class="fas fa-volume-up text-gray-600 dark:text-gray-300 text-base sm:text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Station Modal -->
    <div id="stationModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 id="modalTitle" class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                <span>Add Favorite Station</span>
            </h3>
            <form id="stationForm">
                <input type="hidden" id="stationId">
                <div class="mb-4">
                    <label for="stationNameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Station Name</label>
                    <input type="text" id="stationNameInput" required 
                           class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                           placeholder="E.g., My Favorite Hits">
                </div>
                <div class="mb-6">
                    <label for="stationUrlInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Station Stream URL</label>
                    <input type="url" id="stationUrlInput" required 
                           class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                           placeholder="https://stream.example.com/radio">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelModalBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="saveStationBtn" class="btn-primary">Save Station</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Access Edit Modal -->
    <div id="quickAccessEditModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-edit mr-2 text-blue-500"></i>
                <span>Edit Quick Access</span>
            </h3>
            <div class="mb-6">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Select stations to show in Quick Access:</p>
                <div id="quickAccessEditList" class="space-y-2 max-h-[300px] overflow-y-auto">
                    <!-- Favorites will be listed here for selection -->
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelQuickAccessEditBtn" class="btn-secondary">Cancel</button>
                <button type="button" id="saveQuickAccessEditBtn" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                <span>About Live Beats WRP</span>
            </h3>
            <div class="space-y-4 text-sm text-gray-700 dark:text-gray-300">
                <p>
              <strong>License:</strong> GNU GPL v3<br>
    <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" 
       target="_blank" 
       rel="noopener noreferrer"
       class="text-blue-600 dark:text-blue-400 hover:underline">
       View License Terms
    </a>
  </p>

 <p>
  <strong>Â©2025 <span id="currentYear"></span> Christian Flach</strong><br>
  <a href="mailto:your.email@example.com" 
     class="text-blue-600 dark:text-blue-400 hover:underline">
     Contact: livebeatswrp@gmail.com
  </a><br>
  <a href="https://lbwebradio.github.io/index.html"
     target="_blank"
     rel="noopener noreferrer"
     class="text-blue-600 dark:text-blue-400 hover:underline">
     LBWRP Website
  </a>
</p>

  <p class="text-sm">
    <strong>Version:</strong> 1.3.6
</p>
               
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeInfoModalBtn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div id="importConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Import Stations</h3>
            <p id="importConfirmText" class="mb-6">You're about to import stations. Existing stations with the same URL will be updated.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div id="clearConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Clear All Favorites</h3>
            <p class="mb-6 text-red-500 dark:text-red-400">Are you sure you want to delete all your favorite stations? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClearBtn" class="btn-secondary">Cancel</button>
                <button id="confirmClearBtn" class="btn-danger">Clear All</button>
            </div>
        </div>
    </div>



<!-- Share Modal -->
<div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
    <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-semibold mb-5 flex items-center">
            <i class="fas fa-share-alt mr-2 text-blue-500"></i>
            <span>Share Options</span>
        </h3>
        <div class="space-y-4">
            <div>
                <h4 class="font-medium mb-2">Share Favorites</h4>
                <div id="favoritesToShare" class="max-h-[200px] overflow-y-auto mb-4 border border-gray-200 dark:border-gray-700 rounded-lg p-2">
                    <!-- Favorites checkboxes will be added here -->
                </div>
                <div class="flex justify-between items-center mb-4">
                    <button id="selectAllFavoritesBtn" class="btn-secondary text-sm px-3 py-1">
                        <i class="fas fa-check-square mr-1"></i> Select All
                    </button>
                    <button id="deselectAllFavoritesBtn" class="btn-secondary text-sm px-3 py-1">
                        <i class="fas fa-square mr-1"></i> Deselect All
                    </button>
                </div>
                <button id="shareSelectedFavoritesBtn" class="btn-primary w-full">
                    <i class="fas fa-share mr-2"></i> Share Selected
                </button>
            </div>
            <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                <h4 class="font-medium mb-2">Share App</h4>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Share the Live Beats WebRadio Player with others</p>
                <button id="shareAppBtn" class="btn-primary w-full">
                    <i class="fas fa-mobile-alt mr-2"></i> Share App
                </button>
            </div>
        </div>
        <div class="mt-6 flex justify-end">
            <button type="button" id="closeShareModalBtn" class="btn-secondary">Close</button>
        </div>
    </div>
</div>
 <!-- Theme Palette Modal -->
<div id="themePaletteModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
    <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-2xl border border-gray-200 dark:border-gray-700">
        <h3 class="text-xl font-semibold mb-5 flex items-center">
            <i class="fas fa-palette mr-2 text-blue-500"></i>
            <span>Choose Theme</span>
        </h3>
        
        <!-- Basic Themes (Light/Dark) -->
        <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">BASIC THEMES</h4>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="setLightTheme()" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-white border-2 border-gray-300 mb-1"></div>
                    <span class="text-sm">Light</span>
                </button>
                <button onclick="setDarkTheme()" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gray-900 border-2 border-gray-700 mb-1"></div>
                    <span class="text-sm">Dark</span>
                </button>
            </div>
        </div>
        
        <!-- Color Themes (5 per row) -->
        <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3">COLOR THEMES</h4>
            <div class="grid grid-cols-5 gap-3">
                <!-- Row 1 -->
                <button onclick="setColorTheme('rose')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-rose-500 to-rose-600 mb-1"></div>
                    <span class="text-sm">Rose</span>
                </button>
                <button onclick="setColorTheme('pink')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-pink-500 to-pink-600 mb-1"></div>
                    <span class="text-sm">Pink</span>
                </button>
                <button onclick="setColorTheme('fuchsia')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-fuchsia-500 to-fuchsia-600 mb-1"></div>
                    <span class="text-sm">Fuchsia</span>
                </button>
                <button onclick="setColorTheme('purple')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 mb-1"></div>
                    <span class="text-sm">Purple</span>
                </button>
                <button onclick="setColorTheme('violet')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-violet-500 to-violet-600 mb-1"></div>
                    <span class="text-sm">Violet</span>
                </button>
                
                <!-- Row 2 -->
                <button onclick="setColorTheme('indigo')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-indigo-600 mb-1"></div>
                    <span class="text-sm">Indigo</span>
                </button>
                <button onclick="setColorTheme('blue')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 mb-1"></div>
                    <span class="text-sm">Blue</span>
                </button>
                <button onclick="setColorTheme('sky')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-sky-500 to-sky-600 mb-1"></div>
                    <span class="text-sm">Sky</span>
                </button>
                <button onclick="setColorTheme('cyan')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-cyan-600 mb-1"></div>
                    <span class="text-sm">Cyan</span>
                </button>
                <button onclick="setColorTheme('teal')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-teal-500 to-teal-600 mb-1"></div>
                    <span class="text-sm">Teal</span>
                </button>
                
                <!-- Row 3 -->
                <button onclick="setColorTheme('emerald')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-600 mb-1"></div>
                    <span class="text-sm">Emerald</span>
                </button>
                <button onclick="setColorTheme('green')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-green-600 mb-1"></div>
                    <span class="text-sm">Green</span>
                </button>
                <button onclick="setColorTheme('lime')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-lime-500 to-lime-600 mb-1"></div>
                    <span class="text-sm">Lime</span>
                </button>
                <button onclick="setColorTheme('yellow')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-yellow-500 to-yellow-600 mb-1"></div>
                    <span class="text-sm">Yellow</span>
                </button>
                <button onclick="setColorTheme('amber')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-amber-500 to-amber-600 mb-1"></div>
                    <span class="text-sm">Amber</span>
                </button>
                
                <!-- Row 4 -->
                <button onclick="setColorTheme('orange')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 mb-1"></div>
                    <span class="text-sm">Orange</span>
                </button>
                <button onclick="setColorTheme('red')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-red-600 mb-1"></div>
                    <span class="text-sm">Red</span>
                </button>
                <button onclick="setColorTheme('warmGray')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-warmGray-500 to-warmGray-600 mb-1"></div>
                    <span class="text-sm">Warm Gray</span>
                </button>
                <button onclick="setColorTheme('trueGray')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-trueGray-500 to-trueGray-600 mb-1"></div>
                    <span class="text-sm">True Gray</span>
                </button>
                <button onclick="setColorTheme('gray')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-500 to-gray-600 mb-1"></div>
                    <span class="text-sm">Gray</span>
                </button>
                
                <!-- Row 5 -->
                <button onclick="setColorTheme('coolGray')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-coolGray-500 to-coolGray-600 mb-1"></div>
                    <span class="text-sm">Cool Gray</span>
                </button>
                <button onclick="setColorTheme('blueGray')" class="flex flex-col items-center p-2 transition-colors rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blueGray-500 to-blueGray-600 mb-1"></div>
                    <span class="text-sm">Blue Gray</span>
                </button>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button type="button" id="closeThemePaletteBtn" class="btn-secondary">Close</button>
        </div>
    </div>
</div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white opacity-0 invisible z-[150] max-w-xs sm:max-w-sm text-sm border border-transparent">
        <div class="flex items-start justify-between">
            <div class="flex-shrink-0 pt-0.5">
                <i id="messageIcon" class="fas fa-info-circle mr-3"></i>
            </div>
            <div class="flex-grow">
                <p id="messageText" class="mr-2"></p>
            </div>
            <button id="closeMessageBtn" class="text-lg font-bold leading-none hover:opacity-75 focus:outline-none">&times;</button>
        </div>
    </div>

    <!-- File Input (hidden) -->
    <input type="file" id="fileImportInput" accept=".lbrx" class="hidden">

    <script>
        // DOM Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const infoBtn = document.getElementById('infoBtn');
        const openAddModalBtn = document.getElementById('openAddModalBtn');
        const stationModal = document.getElementById('stationModal');
        const quickAccessEditModal = document.getElementById('quickAccessEditModal');
        const infoModal = document.getElementById('infoModal');
        const importConfirmModal = document.getElementById('importConfirmModal');
        const clearConfirmModal = document.getElementById('clearConfirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
        const stationForm = document.getElementById('stationForm');
        const stationIdInput = document.getElementById('stationId');
        const stationNameInput = document.getElementById('stationNameInput');
        const stationUrlInput = document.getElementById('stationUrlInput');
        const favoritesList = document.getElementById('favoritesList');
        const noFavoritesMsg = document.getElementById('noFavoritesMsg');
        const favoritesCount = document.getElementById('favoritesCount');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeControl = document.getElementById('volumeControl');
        const currentStationName = document.getElementById('currentStationName');
        const currentStationNameCompact = document.getElementById('currentStationNameCompact');
        const nowPlayingSection = document.getElementById('nowPlayingSection');
        const bitrateInfo = document.getElementById('bitrateInfo');
        const quickAccessList = document.getElementById('quickAccessList');
        const quickAccessEditList = document.getElementById('quickAccessEditList');
        const editQuickAccessBtn = document.getElementById('editQuickAccessBtn');
        const cancelQuickAccessEditBtn = document.getElementById('cancelQuickAccessEditBtn');
        const saveQuickAccessEditBtn = document.getElementById('saveQuickAccessEditBtn');
        
        // Direct URL play elements
        const directUrlInput = document.getElementById('directUrlInput');
        const playDirectUrlBtn = document.getElementById('playDirectUrlBtn');
        const addCurrentToFavoritesBtn = document.getElementById('addCurrentToFavoritesBtn');

        // Import/Export Elements
        const importFavoritesBtn = document.getElementById('importFavoritesBtn');
        const exportFavoritesBtn = document.getElementById('exportFavoritesBtn');
        const clearFavoritesBtn = document.getElementById('clearFavoritesBtn');
        const fileImportInput = document.getElementById('fileImportInput');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importConfirmText = document.getElementById('importConfirmText');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        const confirmClearBtn = document.getElementById('confirmClearBtn');




       // Share Modal Elements
const shareBtn = document.getElementById('shareBtn');
const refreshBtn = document.getElementById('refreshBtn');
const shareModal = document.getElementById('shareModal');
const closeShareModalBtn = document.getElementById('closeShareModalBtn');
const favoritesToShare = document.getElementById('favoritesToShare');
const selectAllFavoritesBtn = document.getElementById('selectAllFavoritesBtn');
const deselectAllFavoritesBtn = document.getElementById('deselectAllFavoritesBtn');
const shareSelectedFavoritesBtn = document.getElementById('shareSelectedFavoritesBtn');
const shareAppBtn = document.getElementById('shareAppBtn');


        // Message Box Elements
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageIcon = document.getElementById('messageIcon');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        let messageTimeout;

        let favorites = [];
        let quickAccessStations = [];
        let currentPlayingStation = null;
        let isDirectUrlStream = false;
        let currentLbrxFileName = 'live_beats_favorites.lbrx';
        let audioContext;
        let analyser;
        let bitrateInterval;
        let lastBytes = 0;
       // ====================
// Radio Browser Section
// ====================

// Radio Browser API elements
const radioSearchInput = document.getElementById('radioSearchInput');
const radioSearchBtn = document.getElementById('radioSearchBtn');
const radioBrowserResults = document.getElementById('radioBrowserResults');
const radioBrowserLoading = document.getElementById('radioBrowserLoading');
const radioBrowserEmpty = document.getElementById('radioBrowserEmpty');
const popularTagBtns = document.querySelectorAll('.popular-tag-btn');

// Radio Browser API configuration
const RADIO_BROWSER_USER_AGENT = 'Live Beats WebRadio PWA/1.3.6';
let RADIO_BROWSER_BASE_URL = 'https://de1.api.radio-browser.info';

// Current search state
let currentRadioSearch = '';
let currentRadioResults = [];

// Function to get a random available server
async function getRandomRadioBrowserServer() {
    try {
        const response = await fetch('https://all.api.radio-browser.info/json/servers', {
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        
        if (!response.ok) throw new Error('Failed to fetch servers');
        
        const servers = await response.json();
        const httpsServers = servers.map(server => `https://${server.name}`);
        return httpsServers[Math.floor(Math.random() * httpsServers.length)];
    } catch (error) {
        console.error('Error getting random server, using fallback:', error);
        return 'https://de1.api.radio-browser.info'; // Fallback
    }
}

// Initialize with a random server
async function initializeRadioBrowser() {
    RADIO_BROWSER_BASE_URL = await getRandomRadioBrowserServer();
    console.log('Using Radio Browser server:', RADIO_BROWSER_BASE_URL);
    
    // Load popular stations initially
    searchRadioStations('topclick', 'tag');
}

// Track station click in Radio Browser API
async function trackStationClick(stationUuid) {
    if (!stationUuid) return;
    
    try {
        const url = `${RADIO_BROWSER_BASE_URL}/json/url/${stationUuid}`;
        await fetch(url, {
            method: 'POST',
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        console.log('Station click tracked:', stationUuid);
    } catch (error) {
        console.error('Error tracking station click:', error);
    }
}

// Search radio stations
async function searchRadioStations(searchTerm = '', searchBy = 'name') {
    try {
        // Show loading state
        radioBrowserResults.classList.add('hidden');
        radioBrowserEmpty.classList.add('hidden');
        radioBrowserLoading.classList.remove('hidden');
        
        let apiUrl;
        
        if (searchBy === 'tag') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/${searchTerm}?hidebroken=true&limit=30`;
        } else if (searchBy === 'country') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/bycountry/${encodeURIComponent(searchTerm)}?hidebroken=true&limit=30`;
        } else if (searchBy === 'genre') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/bytagexact/${encodeURIComponent(searchTerm)}?hidebroken=true&limit=30`;
        } else {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/search?name=${encodeURIComponent(searchTerm)}&hidebroken=true&limit=30`;
        }
        
        const response = await fetch(apiUrl, {
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        
        const data = await response.json();
        currentRadioResults = data;
        renderRadioBrowserResults(data);
        
        radioBrowserLoading.classList.add('hidden');
        
        if (data.length > 0) {
            radioBrowserResults.classList.remove('hidden');
            radioBrowserEmpty.classList.add('hidden');
        } else {
            radioBrowserResults.classList.add('hidden');
            radioBrowserEmpty.classList.remove('hidden');
            radioBrowserEmpty.innerHTML = `
                <i class="fas fa-exclamation-circle text-3xl text-gray-300 dark:text-gray-600 mb-3"></i>
                <p class="text-gray-500 dark:text-gray-400">No stations found</p>
            `;
        }
    } catch (error) {
        console.error('Radio Browser API error:', error);
        radioBrowserLoading.classList.add('hidden');
        radioBrowserResults.classList.add('hidden');
        radioBrowserEmpty.classList.remove('hidden');
        radioBrowserEmpty.innerHTML = `
            <i class="fas fa-exclamation-triangle text-3xl text-red-300 dark:text-red-600 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">Failed to load stations</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">${error.message}</p>
        `;
        
        // Try to recover by getting a new server
        RADIO_BROWSER_BASE_URL = await getRandomRadioBrowserServer();
    }
}


// Share Modal Functions
function openShareModal() {
    favoritesToShare.innerHTML = '';
    
    favorites.forEach((station, index) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg mb-1';
        
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-3 cursor-pointer';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'rounded text-blue-600 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600';
        checkbox.checked = false; // Changed from true to false
        checkbox.dataset.url = station.url;
        checkbox.dataset.name = station.name;
        
        const span = document.createElement('span');
        span.className = 'text-sm font-medium text-gray-700 dark:text-gray-300 truncate';
        span.textContent = `${index + 1}. ${station.name}`;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        div.appendChild(label);
        
        favoritesToShare.appendChild(div);
    });
    
    shareModal.classList.remove('invisible', 'opacity-0');
    shareModal.classList.add('open');
}

function closeShareModal() {
    shareModal.classList.add('opacity-0');
    setTimeout(() => {
        shareModal.classList.add('invisible');
        shareModal.classList.remove('open');
    }, 200);
}

function shareSelectedFavorites() {
    const checkboxes = favoritesToShare.querySelectorAll('input[type="checkbox"]:checked');
    
    if (checkboxes.length === 0) {
        showMessage('Please select at least one station to share.', 'info');
        return;
    }
    
    const selectedStations = Array.from(checkboxes).map(checkbox => ({
        name: checkbox.dataset.name,
        url: checkbox.dataset.url
    }));
    
    const appUrl = window.location.href;
    const appName = 'Live Beats WebRadio Player';
    
    let shareText = `Check out my favorite radio stations from ${appName}:\n\n`;
    
    selectedStations.forEach(station => {
        shareText += `â¢ ${station.name}\n${station.url}\n\n`;
    });
    
    // Removed the duplicate app URL at the end
    shareText += `Get the app: ${appUrl}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'My Favorite Radio Stations',
            text: shareText
        }).catch(err => {
            console.log('Error sharing:', err);
            copyToClipboard(shareText);
        });
    } else {
        copyToClipboard(shareText);
    }
}

function shareApp() {
    const appUrl = window.location.href;
    const appName = 'Live Beats WebRadio Player';
    
    // Clean single-line version without duplicate URL
    const shareText = `Check out ${appName} - A free, privacy respecting internet radio player with thousands of stations and no ads!`;
    
    if (navigator.share) {
        // For Web Share API (mobile devices)
        navigator.share({
            title: appName,
            text: shareText,  // Text without URL
            url: appUrl       // URL passed separately
        }).catch(err => {
            console.log('Share failed, falling back to clipboard:', err);
            // Fallback combines text + URL (but only once)
            copyToClipboard(`${shareText}\n${appUrl}`);
        });
    } else {
        // Desktop fallback (URL appears only once)
        copyToClipboard(`${shareText}\n${appUrl}`);
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showMessage('Copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showMessage('Failed to copy to clipboard', 'error');
    });
}

function refreshPlayer() {
    // Simulate pull-to-refresh behavior
    showMessage('Refreshing player...', 'info');
    
    // Reload the page after a short delay to show the message
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

// Event Listeners
shareBtn.addEventListener('click', openShareModal);
closeShareModalBtn.addEventListener('click', closeShareModal);
shareModal.addEventListener('click', (e) => {
    if (e.target === shareModal) closeShareModal();
});
selectAllFavoritesBtn.addEventListener('click', () => {
    favoritesToShare.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = true;
    });
});
deselectAllFavoritesBtn.addEventListener('click', () => {
    favoritesToShare.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
});
shareSelectedFavoritesBtn.addEventListener('click', shareSelectedFavorites);
shareAppBtn.addEventListener('click', shareApp);
refreshBtn.addEventListener('click', refreshPlayer);

       

function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(`${sectionId}ToggleIcon`);
    
    if (section.classList.contains('hidden')) {
        section.classList.remove('hidden');
        icon.classList.remove('fa-plus');
        icon.classList.add('fa-minus');
    } else {
        section.classList.add('hidden');
        icon.classList.remove('fa-minus');
        icon.classList.add('fa-plus');
    }
}
       
// Render radio browser results
// Render radio browser results
function renderRadioBrowserResults(stations) {
    radioBrowserResults.innerHTML = '';
    
    stations.forEach(station => {
        let streamUrl = station.url_resolved || station.url;
        if (!streamUrl) return;
        
        const div = document.createElement('div');
        div.className = 'station-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 dark:border-gray-600 cursor-pointer';
        
        // Make the whole card clickable to play the station
        div.addEventListener('click', (e) => {
            // Don't trigger if clicking on buttons or links inside the card
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button')) {
                return;
            }
            
            // Track the click first
            trackStationClick(station.stationuuid);
            
            playStation({
                id: `radio_browser_${station.stationuuid}`,
                name: station.name,
                url: streamUrl
            }, true);
            
            document.querySelector('#nowPlayingSection').scrollIntoView({
                behavior: 'smooth'
            });
        });
        
        const leftDiv = document.createElement('div');
        leftDiv.className = 'flex items-center min-w-0 flex-grow';
        
        const favicon = document.createElement('img');
        favicon.className = 'w-8 h-8 rounded mr-3 flex-shrink-0';
        // Set default image first
        favicon.src = 'icons/icon-32.png';
        
        // Only try to load station favicon if it exists and isn't empty
        if (station.favicon && station.favicon.trim() !== '') {
            // Create a temporary image to test loading
            const tempImg = new Image();
            tempImg.onload = function() {
                favicon.src = station.favicon;
            };
            tempImg.onerror = function() {
                // Keep the default image if loading fails
                // Already set to default, so no need to do anything
            };
            // Start loading the image
            tempImg.src = station.favicon;
        }
        
        favicon.alt = station.name;
        
        const infoDiv = document.createElement('div');
        infoDiv.className = 'min-w-0';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'font-medium block truncate';
        nameSpan.textContent = station.name;
        
        const metaDiv = document.createElement('div');
        metaDiv.className = 'flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 mt-1';
        
        const countrySpan = document.createElement('span');
        countrySpan.textContent = station.country || 'Unknown';
        
        const genreSpan = document.createElement('span');
        genreSpan.textContent = station.tags || station.genre || 'Various';
        genreSpan.className = 'truncate';
        
        metaDiv.appendChild(countrySpan);
        metaDiv.appendChild(document.createTextNode('â¢'));
        metaDiv.appendChild(genreSpan);
        
        infoDiv.appendChild(nameSpan);
        infoDiv.appendChild(metaDiv);
        leftDiv.appendChild(favicon);
        leftDiv.appendChild(infoDiv);
        
        const playBtn = document.createElement('button');
        playBtn.className = 'icon-btn text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300';
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        playBtn.title = `Play ${station.name}`;
        playBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the card click from triggering
            trackStationClick(station.stationuuid);
            playStation({
                id: `radio_browser_${station.stationuuid}`,
                name: station.name,
                url: streamUrl
            }, true);
            document.querySelector('#nowPlayingSection').scrollIntoView({
                behavior: 'smooth'
            });
        });
        
const addBtn = document.createElement('button');
const isAlreadyFavorite = favorites.some(fav => fav.url === streamUrl);
addBtn.className = `icon-btn ${isAlreadyFavorite ? 'text-green-500 dark:text-green-400' : 'text-yellow-500 dark:text-yellow-400'}`;
addBtn.innerHTML = isAlreadyFavorite ? '<i class="fas fa-check"></i>' : '<i class="fas fa-star"></i>';
addBtn.title = isAlreadyFavorite ? 'Already in favorites' : `Add ${station.name} to favorites`;
addBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (isAlreadyFavorite) {
        showMessage('This station is already in your favorites!', 'info');
    } else {
        openModal('add', {
            name: station.name,
            url: streamUrl
        });
    }
});
        
        div.appendChild(leftDiv);
        div.appendChild(playBtn);
        div.appendChild(addBtn);
        radioBrowserResults.appendChild(div);
    });
}

// Event listeners for radio browser
radioSearchBtn.addEventListener('click', () => {
    const searchTerm = radioSearchInput.value.trim();
    if (searchTerm) {
        currentRadioSearch = searchTerm;
        searchRadioStations(searchTerm);
    }
});

radioSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const searchTerm = radioSearchInput.value.trim();
        if (searchTerm) {
            currentRadioSearch = searchTerm;
            searchRadioStations(searchTerm);
        }
    }
});

popularTagBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tag = btn.dataset.tag;
        radioSearchInput.value = '';
        
        // Remove the country case
        if (tag === 'genre') {
            const genre = prompt('Enter genre (e.g., rock, jazz, pop):');
            if (genre) {
                searchRadioStations(genre, 'genre');
            }
        } else {
            searchRadioStations(tag, 'tag');
        }
    });
});

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeRadioBrowser);

        // Default quick access stations
        const defaultQuickAccessStations = [
            { name: "BBC Radio 1", url: "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one", icon: "fab fa-bbc" },
            { name: "BBC Radio 2", url: "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_two", icon: "fab fa-bbc" },
            { name: "Classic FM", url: "https://icecast.thisisdax.com/ClassicFMMP3", icon: "fas fa-music" },
            { name: "Radio Swiss Jazz", url: "https://stream.srg-ssr.ch/m/rsj/mp3_128", icon: "fas fa-globe-europe" },
            { name: "Radio France", url: "https://stream.srg-ssr.ch/m/rsj/mp3_128", icon: "fas fa-broadcast-tower" },
            { name: "Radio Paradise", url: "https://stream.radioparadise.com/flac", icon: "fas fa-parachute-box" }
        ];

        // --- Message Box Logic ---
function showMessage(message, type = 'info', duration = 3000) {
    // Clear any existing message
    messageText.textContent = message;
    messageBox.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white opacity-0 invisible z-[150] max-w-xs sm:max-w-sm text-sm border border-transparent';
    
    // Set colors based on type (NO SPACES IN CLASS LISTS!)
    const colorClasses = {
        success: ['bg-green-600', 'border-green-700'],
        error: ['bg-red-600', 'border-red-700'],
        warning: ['bg-amber-500', 'border-amber-600'],
        info: ['bg-blue-600', 'border-blue-700']
    };
    
    // Add each class individually
    colorClasses[type].forEach(cls => messageBox.classList.add(cls));
    
    // Set icon
    messageIcon.className = `fas ${
        type === 'success' ? 'fa-check-circle' :
        type === 'error' ? 'fa-exclamation-circle' :
        type === 'warning' ? 'fa-exclamation-triangle' :
        'fa-info-circle'
    } mr-3`;
    
    // Show message
    messageBox.classList.remove('invisible', 'opacity-0');
    messageBox.classList.add('opacity-100', 'animate-fade-in');
    
    // Auto-hide
    clearTimeout(messageTimeout);
    messageTimeout = setTimeout(hideMessage, duration);
}

        function hideMessage() {
            messageBox.classList.remove('opacity-100');
            messageBox.classList.add('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('invisible');
            }, 300);
        }
        closeMessageBtn.addEventListener('click', hideMessage);

        // --- Theme Management ---
// --- Theme Management ---
function setLightTheme() {
    document.documentElement.classList.remove('dark');
    document.documentElement.classList.add('light');
    localStorage.setItem('theme', 'light');
    localStorage.removeItem('colorTheme');
    applyColorTheme(null);
    closeThemePaletteModal();
}

function setDarkTheme() {
    document.documentElement.classList.add('dark');
    document.documentElement.classList.remove('light');
    localStorage.setItem('theme', 'dark');
    localStorage.removeItem('colorTheme');
    applyColorTheme(null);
    closeThemePaletteModal();
}

function setColorTheme(color) {
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
    } else {
        document.documentElement.classList.remove('dark');
        document.documentElement.classList.add('light');
    }
    localStorage.setItem('colorTheme', color);
    applyColorTheme(color);
    closeThemePaletteModal();
}

function applyColorTheme(color) {
    // Remove all color theme classes first
    document.documentElement.classList.remove(
        'theme-rose', 'theme-pink', 'theme-fuchsia', 'theme-purple', 'theme-violet',
        'theme-indigo', 'theme-blue', 'theme-sky', 'theme-cyan', 'theme-teal',
        'theme-emerald', 'theme-green', 'theme-lime', 'theme-yellow', 'theme-amber',
        'theme-orange', 'theme-red', 'theme-warmGray', 'theme-trueGray', 'theme-gray',
        'theme-coolGray', 'theme-blueGray'
    );
    
    if (color) {
        document.documentElement.classList.add(`theme-${color}`);
    }
    
    // Update UI elements to reflect the new theme
    updateThemeDependentElements(color);
}

function updateThemeDependentElements(color) {
    // Update buttons, gradients, etc. based on the current theme
    const primaryColor = color || 'blue'; // Default to blue if no color theme
    
    // Update primary buttons
    document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.className = btn.className.replace(
            /from-\w+-\d+ to-\w+-\d+/g, 
            `from-${primaryColor}-600 to-${primaryColor}-600 hover:from-${primaryColor}-700 hover:to-${primaryColor}-700`
        );
    });
    
    // Update gradient text
    document.querySelectorAll('.gradient-text').forEach(el => {
        el.className = el.className.replace(
            /from-\w+-\d+ to-\w+-\d+/g, 
            `from-${primaryColor}-600 to-${primaryColor}-600 dark:from-${primaryColor}-400 dark:to-${primaryColor}-400`
        );
    });
    
    // You can add more element updates as needed
}

// Theme Palette Modal Functions
function openThemePaletteModal() {
    themePaletteModal.classList.remove('invisible', 'opacity-0');
    themePaletteModal.classList.add('open');
}

function closeThemePaletteModal() {
    themePaletteModal.classList.add('opacity-0');
    setTimeout(() => {
        themePaletteModal.classList.add('invisible');
        themePaletteModal.classList.remove('open');
    }, 200);
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme');
    const colorTheme = localStorage.getItem('colorTheme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.documentElement.classList.add('dark');
        document.documentElement.classList.remove('light');
    } else {
        document.documentElement.classList.remove('dark');
        document.documentElement.classList.add('light');
    }
    
    if (colorTheme) {
        applyColorTheme(colorTheme);
    }
}

        // --- Modal Management ---
        function openModal(mode = 'add', station = null) {
            stationModal.classList.remove('invisible', 'opacity-0');
            stationModal.classList.add('open');
            stationForm.reset();
            stationIdInput.value = '';

            if (mode === 'edit' && station) {
                modalTitle.innerHTML = '<i class="fas fa-edit mr-2 text-blue-500"></i><span>Edit Favorite Station</span>';
                stationIdInput.value = station.id;
                stationNameInput.value = station.name;
                stationUrlInput.value = station.url;
            } else {
                modalTitle.innerHTML = '<i class="fas fa-plus-circle mr-2 text-blue-500"></i><span>Add Favorite Station</span>';
                if (station && station.url) {
                    stationUrlInput.value = station.url;
                    if (station.name && station.name !== "Direct Stream" && !station.name.startsWith("http")) {
                        stationNameInput.value = station.name;
                    } else {
                        try {
                            const urlObj = new URL(station.url);
                            stationNameInput.value = urlObj.hostname.replace(/^www\./, '');
                        } catch (e) {
                            stationNameInput.value = '';
                        }
                    }
                }
            }
            stationNameInput.focus();
        }

        function closeModal() {
            stationModal.classList.add('opacity-0');
            setTimeout(() => {
                stationModal.classList.add('invisible');
                stationModal.classList.remove('open');
            }, 200);
        }

        function openQuickAccessEditModal() {
            quickAccessEditList.innerHTML = '';
            
            // Add favorites to the edit list
            favorites.forEach(station => {
                const isInQuickAccess = quickAccessStations.some(q => q.url === station.url);
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg';
                
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 cursor-pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'rounded text-blue-600 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600';
                checkbox.checked = isInQuickAccess;
                checkbox.dataset.url = station.url;
                checkbox.dataset.name = station.name;
                
                const span = document.createElement('span');
                span.className = 'text-sm font-medium text-gray-700 dark:text-gray-300';
                span.textContent = station.name;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                div.appendChild(label);
                
                quickAccessEditList.appendChild(div);
            });
            
            quickAccessEditModal.classList.remove('invisible', 'opacity-0');
            quickAccessEditModal.classList.add('open');
        }

        function closeQuickAccessEditModal() {
            quickAccessEditModal.classList.add('opacity-0');
            setTimeout(() => {
                quickAccessEditModal.classList.add('invisible');
                quickAccessEditModal.classList.remove('open');
            }, 200);
        }

        function openInfoModal() {
            infoModal.classList.remove('invisible', 'opacity-0');
            infoModal.classList.add('open');
        }

        function closeInfoModal() {
            infoModal.classList.add('opacity-0');
            setTimeout(() => {
                infoModal.classList.add('invisible');
                infoModal.classList.remove('open');
            }, 200);
        }

        function openImportConfirmModal(stationCount) {
            importConfirmText.textContent = `You're about to import ${stationCount} stations. Existing stations with the same URL will be updated.`;
            importConfirmModal.classList.remove('invisible', 'opacity-0');
            importConfirmModal.classList.add('open');
        }

        function closeImportConfirmModal() {
            importConfirmModal.classList.add('opacity-0');
            setTimeout(() => {
                importConfirmModal.classList.add('invisible');
                importConfirmModal.classList.remove('open');
            }, 200);
        }

        function openClearConfirmModal() {
            clearConfirmModal.classList.remove('invisible', 'opacity-0');
            clearConfirmModal.classList.add('open');
        }

        function closeClearConfirmModal() {
            clearConfirmModal.classList.add('opacity-0');
            setTimeout(() => {
                clearConfirmModal.classList.add('invisible');
                clearConfirmModal.classList.remove('open');
            }, 200);
        }

        openAddModalBtn.addEventListener('click', () => openModal('add'));
        editQuickAccessBtn.addEventListener('click', openQuickAccessEditModal);
        cancelQuickAccessEditBtn.addEventListener('click', closeQuickAccessEditModal);
        infoBtn.addEventListener('click', openInfoModal);
        closeInfoModalBtn.addEventListener('click', closeInfoModal);
        cancelModalBtn.addEventListener('click', closeModal);
        
        stationModal.addEventListener('click', (e) => {
            if (e.target === stationModal) closeModal();
        });
        
        quickAccessEditModal.addEventListener('click', (e) => {
            if (e.target === quickAccessEditModal) closeQuickAccessEditModal();
        });
        
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) closeInfoModal();
        });
        
        importConfirmModal.addEventListener('click', (e) => {
            if (e.target === importConfirmModal) closeImportConfirmModal();
        });
        
        clearConfirmModal.addEventListener('click', (e) => {
            if (e.target === clearConfirmModal) closeClearConfirmModal();
        });

        // Save quick access changes
        saveQuickAccessEditBtn.addEventListener('click', () => {
            const checkboxes = quickAccessEditList.querySelectorAll('input[type="checkbox"]:checked');
            const newQuickAccess = [];
            
            checkboxes.forEach(checkbox => {
                newQuickAccess.push({
                    name: checkbox.dataset.name,
                    url: checkbox.dataset.url
                });
            });
            
            // If no stations selected, keep at least one default
            if (newQuickAccess.length === 0) {
                newQuickAccess.push(defaultQuickAccessStations[0]);
                showMessage('At least one station must be in Quick Access. Kept first default station.', 'info');
            }
            
            quickAccessStations = newQuickAccess;
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            renderQuickAccess();
            closeQuickAccessEditModal();
            showMessage('Quick Access updated!', 'success');
        });

        // --- Favorites Management ---
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('radioFavorites');
            favorites = storedFavorites ? JSON.parse(storedFavorites) : [];
            
            const storedQuickAccess = localStorage.getItem('quickAccessStations');
            quickAccessStations = storedQuickAccess ? JSON.parse(storedQuickAccess) : defaultQuickAccessStations;
            
            const storedFilename = localStorage.getItem('currentLbrxFileName');
            if (storedFilename) currentLbrxFileName = storedFilename;
            
            renderFavorites();
            renderQuickAccess();
            updateFavoritesCount();
        }

        function saveFavorites() {
            localStorage.setItem('radioFavorites', JSON.stringify(favorites));
            updateLBRXFile();
            renderFavorites();
            renderQuickAccess();
            updateFavoritesCount();
        }

        function updateFavoritesCount() {
            const count = favorites.length;
            favoritesCount.textContent = `${count} station${count !== 1 ? 's' : ''}`;
        }

        function updateLBRXFile() {
            let lbrxContent = generateLBRXContent();
            localStorage.setItem('radioFavoritesLBRX', lbrxContent);
        }

      function generateLBRXContent() {
    let content = "## LIVE BEATS WEBRADIO PLAYER EXPORT ##\n";
    content += `## Date: ${new Date().toISOString()}\n`;
    content += `## Version: 1.3.6\n`;
    content += `=== FAVORITE STATIONS (${favorites.length} stations) ===\n\n`;
    
    // Add numbered stations with exact WinForms formatting
    favorites.forEach((station, index) => {
        content += `${index + 1}. ${station.name}\n${station.url}\n\n`;
    });
    
    content += "## END OF EXPORT ##";
    return content;
}

        function renderQuickAccess() {
            quickAccessList.innerHTML = '';
            
            quickAccessStations.forEach(station => {
                const button = document.createElement('button');
                button.className = 'quick-access-btn btn-secondary text-left truncate';
                button.dataset.url = station.url;
                button.dataset.name = station.name;
                
                // Try to find icon from default stations
                const defaultStation = defaultQuickAccessStations.find(s => s.url === station.url);
                const iconClass = defaultStation ? defaultStation.icon : 'fas fa-radio';
                
                button.innerHTML = `
                    <i class="${iconClass} mr-2"></i>
                    <span class="truncate">${station.name}</span>
                `;
                
                button.addEventListener('click', () => {
                    directUrlInput.value = station.url;
                    playStation({ 
                        id: 'quick_' + Date.now(), 
                        name: station.name, 
                        url: station.url 
                    }, true);
                });
                
                quickAccessList.appendChild(button);
            });
        }

        function renderFavorites() {
           console.log('Rendering favorites:', favorites); 
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavoritesMsg.style.display = 'block';
            } else {
                noFavoritesMsg.style.display = 'none';
                
                favorites.forEach((station, index) => {
                    const isPlaying = currentPlayingStation && currentPlayingStation.id === station.id;
                    const isInQuickAccess = quickAccessStations.some(q => q.url === station.url);
                    
                    const div = document.createElement('div');
                    div.className = `station-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 dark:border-gray-600 ${isPlaying ? 'border-blue-500 dark:border-blue-400' : ''}`;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex items-center min-w-0 flex-grow';
                    
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'text-gray-500 dark:text-gray-400 text-sm font-medium mr-3 w-5 text-right';
                    numberSpan.textContent = `${index + 1}.`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = station.name;
                    nameSpan.className = 'font-medium cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 flex-grow truncate mr-2 text-sm sm:text-base';
                    nameSpan.title = `Play ${station.name}`;
                    nameSpan.addEventListener('click', () => playStation(station, false));
                    
                    leftDiv.appendChild(numberSpan);
                    leftDiv.appendChild(nameSpan);
                    
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'flex items-center space-x-1 sm:space-x-2 flex-shrink-0';
                    
                    if (isPlaying) {
                        const playingIndicator = document.createElement('div');
                        playingIndicator.className = 'waveform text-blue-500 dark:text-blue-400 mr-1';
                        playingIndicator.innerHTML = `
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        `;
                        controlsDiv.appendChild(playingIndicator);
                    }
                    
                    // Add to quick access button
                    const quickAccessBtn = document.createElement('button');
                    quickAccessBtn.className = `icon-btn ${isInQuickAccess ? 'text-yellow-500 dark:text-yellow-400' : 'text-gray-400 dark:text-gray-500'}`;
                    quickAccessBtn.innerHTML = '<i class="fas fa-bolt"></i>';
                    quickAccessBtn.title = isInQuickAccess ? 'Remove from Quick Access' : 'Add to Quick Access';
                    quickAccessBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleQuickAccessStation(station);
                    });
                    
                    const playBtnItem = document.createElement('button');
                    playBtnItem.className = `icon-btn ${isPlaying ? 'text-blue-500 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`;
                    playBtnItem.innerHTML = `<i class="fas fa-${isPlaying ? 'pause' : 'play'}"></i>`;
                    playBtnItem.title = isPlaying ? `Pause ${station.name}` : `Play ${station.name}`;
                    playBtnItem.setAttribute('aria-label', isPlaying ? `Pause ${station.name}` : `Play ${station.name}`);
                    playBtnItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isPlaying && !audioPlayer.paused) {
                            audioPlayer.pause();
                        } else {
                            playStation(station, false);
                        }
                    });
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn text-gray-500 dark:text-gray-400 hover:text-yellow-500 dark:hover:text-yellow-400';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = `Edit ${station.name}`;
                    editBtn.setAttribute('aria-label', `Edit ${station.name}`);
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal('edit', station);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.title = `Delete ${station.name}`;
                    deleteBtn.setAttribute('aria-label', `Delete ${station.name}`);
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteFavorite(station.id);
                    });
                    
                    controlsDiv.appendChild(quickAccessBtn);
                    controlsDiv.appendChild(playBtnItem);
                    controlsDiv.appendChild(editBtn);
                    controlsDiv.appendChild(deleteBtn);
                    
                    div.appendChild(leftDiv);
                    div.appendChild(controlsDiv);
                    favoritesList.appendChild(div);
                });
            }
        }

        function toggleQuickAccessStation(station) {
            const index = quickAccessStations.findIndex(q => q.url === station.url);
            
            if (index > -1) {
                // Remove from quick access
                quickAccessStations.splice(index, 1);
                showMessage(`Removed "${station.name}" from Quick Access`, 'info');
            } else {
                // Add to quick access
                quickAccessStations.push({
                    name: station.name,
                    url: station.url
                });
                showMessage(`Added "${station.name}" to Quick Access`, 'success');
            }
            
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            renderQuickAccess();
            renderFavorites();
        }

        stationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = stationIdInput.value;
            const name = stationNameInput.value.trim();
            const url = stationUrlInput.value.trim();

            if (!name || !url) {
                showMessage('Station Name and URL are required.', 'error');
                return;
            }

            try {
                new URL(url); // Validate URL format
            } catch (_) {
                showMessage('Please enter a valid URL format (e.g., https://...).', 'error');
                return;
            }

            if (id) { // Editing existing
                const index = favorites.findIndex(s => s.id.toString() === id);
                if (index > -1) {
                    favorites[index] = { ...favorites[index], name, url };
                    showMessage('Station updated successfully!', 'success');
                    saveFavorites();
                    
                    // Update current playing station if it's the one being edited
                    if (currentPlayingStation && currentPlayingStation.id === id) {
                        currentPlayingStation = { ...currentPlayingStation, name, url };
                        currentStationName.textContent = name;
                        currentStationNameCompact.textContent = name;
                    }
                }
            } else { // Adding new
                if (favorites.some(fav => fav.url === url)) {
                    showMessage('This station URL is already in your favorites.', 'info');
                    closeModal();
                    return;
                }
                
                const newStation = { id: Date.now().toString(), name, url };
                favorites.push(newStation);
                showMessage('Station added to favorites!', 'success');
                saveFavorites();
                
                // If the newly added station is the one currently playing from a direct URL
                if (currentPlayingStation && currentPlayingStation.url === url && isDirectUrlStream) {
                    isDirectUrlStream = false;
                    addCurrentToFavoritesBtn.classList.add('hidden');
                    currentPlayingStation = newStation;
                }
            }
            
            closeModal();
        });

        function deleteFavorite(id) {
            const stationToDelete = favorites.find(s => s.id === id);
            const isPlaying = currentPlayingStation && stationToDelete && currentPlayingStation.url === stationToDelete.url;
            
            // Create a custom confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 z-[100]';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Delete Station</h3>
                    <p class="mb-6">Are you sure you want to delete "${stationToDelete.name}"?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDeleteBtn" class="btn-secondary">Cancel</button>
                        <button id="confirmDeleteBtn" class="btn-danger">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const cancelBtn = modal.querySelector('#cancelDeleteBtn');
            const confirmBtn = modal.querySelector('#confirmDeleteBtn');
            
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            confirmBtn.addEventListener('click', () => {
                favorites = favorites.filter(s => s.id !== id);
                
                // Also remove from quick access if it's there
                quickAccessStations = quickAccessStations.filter(q => q.url !== stationToDelete.url);
                localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
                
                saveFavorites();
                showMessage('Station deleted.', 'info');
                
                if (isPlaying) {
                    stopPlayback();
                }
                
                document.body.removeChild(modal);
            });
        }

        // --- Import/Export Functions ---
        importFavoritesBtn.addEventListener('click', () => {
            fileImportInput.click();
        });

        exportFavoritesBtn.addEventListener('click', exportFavorites);
        
        clearFavoritesBtn.addEventListener('click', () => {
            if (favorites.length === 0) {
                showMessage('No favorites to clear.', 'info');
                return;
            }
            openClearConfirmModal();
        });

        fileImportInput.addEventListener('change', handleFileImport);

        cancelImportBtn.addEventListener('click', closeImportConfirmModal);
        confirmImportBtn.addEventListener('click', confirmImport);
        
        cancelClearBtn.addEventListener('click', closeClearConfirmModal);
        confirmClearBtn.addEventListener('click', confirmClearFavorites);

       async function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.lbrx')) {
        showMessage('Please select a .lbrx file for import.', 'error');
        return; // REMOVED fileInput.value clearing
    }

    try {
        const content = await readFileAsText(file);
        const importedStations = parseLBRXFile(content);
        
        if (importedStations.length === 0) {
            showMessage('No valid stations found in the import file.', 'info');
            return;
        }

        // STORE THE FILE REFERENCE
        window.pendingImportFile = file; // NEW LINE
        openImportConfirmModal(importedStations.length);
        
    } catch (error) {
        console.error('Import error:', error);
        showMessage('Failed to read file: ' + error.message, 'error');
    }
}

function confirmImport() {
    // USE THE STORED FILE REFERENCE
    const file = window.pendingImportFile || fileImportInput.files[0];
    
    if (!file) {
        showMessage('No file selected', 'error');
        return;
    }

    readFileAsText(file)
        .then(content => {
            const importedStations = parseLBRXFile(content);
            
            // SIMPLE MERGE LOGIC
            importedStations.forEach(newStation => {
                if (!favorites.some(s => s.url === newStation.url)) {
                    favorites.push(newStation);
                }
            });
            
            // FORCE UPDATE
            localStorage.setItem('radioFavorites', JSON.stringify(favorites));
            renderFavorites();
            updateFavoritesCount();
            
            showMessage(`Imported ${importedStations.length} stations!`, 'success');
        })
        .catch(error => {
            showMessage('Import failed: ' + error.message, 'error');
        })
        .finally(() => {
            closeImportConfirmModal();
            fileImportInput.value = ''; // Clear here instead
            delete window.pendingImportFile; // Clean up
        });
}

        function confirmClearFavorites() {
            favorites = [];
            quickAccessStations = defaultQuickAccessStations; // Reset to defaults
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            saveFavorites();
            showMessage('All favorites cleared and Quick Access reset.', 'info');
            closeClearConfirmModal();
            
            if (currentPlayingStation) {
                stopPlayback();
            }
        }

        function exportFavorites() {
            if (favorites.length === 0) {
                showMessage('No favorites to export.', 'info');
                return;
            }

            const lbrxContent = generateLBRXContent();
            const blob = new Blob([lbrxContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentLbrxFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`Favorites exported to ${currentLbrxFileName}!`, 'success');
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('File reading failed'));
                reader.readAsText(file);
            });
        }

    function parseLBRXFile(content) {
    const stations = [];
    const lines = content.split('\n');
    let currentStation = null;
    let inStationsSection = false;

    for (const line of lines) {
        const trimmed = line.trim();
        
        // Skip empty lines and comments
        if (!trimmed || trimmed.startsWith('##')) continue;
        
        // Detect stations section
        if (trimmed.includes('FAVORITE STATIONS')) {
            inStationsSection = true;
            continue;
        }
        
        // Skip section end markers
        if (trimmed.startsWith('===')) continue;

        if (inStationsSection) {
            // Check if line looks like a URL
            if (trimmed.match(/^https?:\/\//i)) {
                if (currentStation) {
                    currentStation.url = trimmed;
                    
                    // Validate URL
                    try {
                        new URL(currentStation.url);
                        stations.push(currentStation);
                    } catch (e) {
                        console.warn('Invalid URL skipped:', currentStation.url);
                    }
                    currentStation = null;
                }
            } 
            // Otherwise treat as station name (clean up numbering)
            else if (!currentStation) {
                const cleanName = trimmed
                    .replace(/^\d+\.\s*/, '')  // Remove leading "1. "
                    .replace(/^\d+\.\w+\s*-\s*/i, '');  // Remove "1.FM - "
                
                currentStation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    name: cleanName,
                    url: ''
                };
            }
        }
    }
    
    console.log('Parsed stations:', stations);
    return stations;
}

        function processImportedStations(importedStations) {
            const results = {
                added: 0,
                skipped: 0,
                updated: 0
            };
            
            for (const imported of importedStations) {
                const existingByUrl = favorites.find(f => f.url === imported.url);
                
                if (existingByUrl) {
                    if (existingByUrl.name !== imported.name) {
                        existingByUrl.name = imported.name;
                        results.updated++;
                    } else {
                        results.skipped++;
                    }
                    continue;
                }
                
                const existingByName = favorites.find(f => f.name === imported.name);
                if (existingByName) {
                    results.skipped++;
                    continue;
                }
                
                favorites.push(imported);
                results.added++;
            }
            
            return results;
        }

        function showImportResults(results) {
            let message = '';
            
            if (results.added > 0) {
                message += `Added ${results.added} new stations. `;
            }
            if (results.updated > 0) {
                message += `Updated ${results.updated} existing stations. `;
            }
            if (results.skipped > 0) {
                message += `Skipped ${results.skipped} duplicates.`;
            }
            
            showMessage(message.trim(), 'success', 5000);
        }

        // --- Audio Player Logic ---
       function playStation(station, isDirect = false) {
    try {
        if (!station || !station.url) {
            showMessage('Invalid station data.', 'error');
            return;
        }

        // Stop any current playback
        stopPlayback();
        
        // Check if station is already in favorites
        const isAlreadyFavorite = favorites.some(fav => fav.url === station.url);
        
        // Show/hide the add to favorites button
        if (isDirect && !isAlreadyFavorite) {
            addCurrentToFavoritesBtn.classList.remove('hidden');
            addCurrentToFavoritesBtn.innerHTML = '<i class="fas fa-star"></i>';
            addCurrentToFavoritesBtn.title = 'Add current station to favorites';
        } else {
            addCurrentToFavoritesBtn.classList.add('hidden');
        }
                
                // Setup audio context for visualization if not already done
                setupAudioContext();
                
                // Enable CORS mode
                audioPlayer.crossOrigin = "anonymous";
                
                // Create a clean URL with cache busting
                let streamUrl = station.url;
                
                // Show loading state
                currentStationName.textContent = 'Loading...';
                currentStationNameCompact.textContent = 'Loading...';
                playPauseBtn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
                
                // 1. First try direct play (works for CORS-enabled streams)
                audioPlayer.src = streamUrl + (streamUrl.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
                
                audioPlayer.play()
                    .then(() => {
                        // Success case
                        currentPlayingStation = station;
                        currentStationName.textContent = station.name;
                        currentStationNameCompact.textContent = station.name;
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        playPauseBtn.setAttribute('aria-label', 'Pause');
                        nowPlayingSection.classList.remove('hidden');

                        isDirectUrlStream = isDirect;
                        const isAlreadyFavorite = favorites.some(fav => fav.url === station.url);

              // Show/hide the add to favorites button
if (isDirect && !isAlreadyFavorite) {
    addCurrentToFavoritesBtn.classList.remove('hidden');
    addCurrentToFavoritesBtn.innerHTML = '<i class="fas fa-star"></i>';
    addCurrentToFavoritesBtn.title = 'Add current station to favorites';
} else if (!isDirect && isAlreadyFavorite) {
    addCurrentToFavoritesBtn.classList.add('hidden');
} else {
    addCurrentToFavoritesBtn.classList.add('hidden');
}
                        
                        // Start bitrate monitoring
                        startBitrateMonitoring();
                        
                        // Update UI to show playing state
                        renderFavorites();
                    })
                    .catch(error => {
                        console.error("Direct play failed, trying proxy:", error);
                        
                        // 2. Fallback to CORS proxy
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(streamUrl)}`;
                        audioPlayer.src = proxyUrl;
                        
                        return audioPlayer.play().then(() => {
                            // Proxy success
                            currentPlayingStation = station;
                            currentStationName.textContent = station.name + " (via proxy)";
                            currentStationNameCompact.textContent = station.name + " (proxy)";
                            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                            nowPlayingSection.classList.remove('hidden');
                            
                            // Start bitrate monitoring
                            startBitrateMonitoring();
                            
                            // Update UI to show playing state
                            renderFavorites();
                        }).catch(proxyError => {
                            // Final failure
                            console.error("Proxy playback failed:", proxyError);
                            showMessage(`Cannot play: ${station.name}. Try another stream.`, 'error');
                            currentStationName.textContent = "Playback Error";
                            currentStationNameCompact.textContent = "Error";
                            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                            nowPlayingSection.classList.add('hidden');
                            stopBitrateMonitoring();
                        });
                    });
            } catch (error) {
                console.error("Setup error:", error);
                showMessage(`Error with station: ${station.name}`, 'error');
                addCurrentToFavoritesBtn.classList.add('hidden');
                nowPlayingSection.classList.add('hidden');
                stopBitrateMonitoring();
            }
        }
        
        function setupAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 32;
                    
                    const source = audioContext.createMediaElementSource(audioPlayer);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (e) {
                    console.warn('Web Audio API not supported:', e);
                }
            }
        }
        
        function startBitrateMonitoring() {
            stopBitrateMonitoring();
            lastBytes = 0;
            bitrateInterval = setInterval(updateBitrateInfo, 2000);
        }
        
        function stopBitrateMonitoring() {
            if (bitrateInterval) {
                clearInterval(bitrateInterval);
                bitrateInterval = null;
            }
            bitrateInfo.textContent = '';
        }
        
        function updateBitrateInfo() {
            if (audioPlayer.buffered.length > 0) {
                const bytesLoaded = audioPlayer.buffered.end(0) * audioPlayer.duration * 1000;
                const bytesDiff = bytesLoaded - lastBytes;
                const bitrate = Math.round((bytesDiff * 8) / 2000); // kbps
                
                if (bitrate > 0) {
                    bitrateInfo.textContent = `${bitrate} kbps`;
                }
                
                lastBytes = bytesLoaded;
            }
        }
        
        // Event listener for playDirectUrlBtn
        playDirectUrlBtn.addEventListener('click', () => {
            const url = directUrlInput.value.trim();
            if (url) {
                try {
                    new URL(url);
                } catch (_) {
                    showMessage('Please enter a valid stream URL format (e.g., https://...).', 'error');
                    return;
                }

                let name = "Direct Stream";
                try {
                    const urlObj = new URL(url);
                    name = urlObj.hostname.replace(/^www\./, '') || "Direct Stream";
                } catch (e) { /* ignore if URL is not standard for hostname extraction */ }

                playStation({ id: 'direct_' + Date.now(), name: name, url: url }, true);
            } else {
                showMessage('Please enter a stream URL.', 'error');
            }
        });

        function togglePlayPause() {
            if (!currentPlayingStation && favorites.length > 0) {
                playStation(favorites[0], false);
                return;
            }
            if (!currentPlayingStation) {
                showMessage('No station selected to play.', 'info');
                return;
            }

            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => {
                    showMessage('Error resuming playback.', 'error');
                    console.error("Play error:", e);
                });
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'Pause');
            } else {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
            }
            
            renderFavorites();
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (audioPlayer.src) audioPlayer.src = "";
            
            currentPlayingStation = null;
            isDirectUrlStream = false;
            currentStationName.textContent = '---';
            currentStationNameCompact.textContent = '---';
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            addCurrentToFavoritesBtn.classList.add('hidden');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        }

       function addCurrentToFavorites() {
    if (!currentPlayingStation || !currentPlayingStation.url) {
        showMessage('No station currently playing to add to favorites.', 'info');
        return;
    }
    
    // Check if already in favorites
    const isAlreadyFavorite = favorites.some(fav => fav.url === currentPlayingStation.url);
    if (isAlreadyFavorite) {
        showMessage('This station is already in your favorites!', 'info');
        return;
    }
    
    // Generate a name if it's a direct URL stream
    let name = currentPlayingStation.name;
    if (isDirectUrlStream && name === "Direct Stream") {
        try {
            const urlObj = new URL(currentPlayingStation.url);
            name = urlObj.hostname.replace(/^www\./, '') || "Custom Station";
        } catch (e) {
            name = "Custom Station";
        }
    }
    
    // Open the add modal with the current station's info
    openModal('add', {
        name: name,
        url: currentPlayingStation.url
    });
    
    // Hide the button since we're adding it to favorites
    addCurrentToFavoritesBtn.classList.add('hidden');
}

        playPauseBtn.addEventListener('click', togglePlayPause);
        stopBtn.addEventListener('click', stopPlayback);
       addCurrentToFavoritesBtn.addEventListener('click', addCurrentToFavorites);

        volumeControl.addEventListener('input', (e) => {
            audioPlayer.volume = parseFloat(e.target.value);
        });
        audioPlayer.volume = parseFloat(volumeControl.value);

        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio Player Error Event:', e);
            let errorMessage = "Error playing audio.";
            if (currentPlayingStation) {
                errorMessage = `Playback error for: ${currentPlayingStation.name}. The stream might be offline or the URL incorrect.`;
            }
            showMessage(errorMessage, 'error', 5000);
            currentStationName.textContent = "Playback Error";
            currentStationNameCompact.textContent = "Error";
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        });

        audioPlayer.addEventListener('ended', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            showMessage('Stream ended or was interrupted.', 'info');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        });
        
        audioPlayer.onplaying = () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'Pause');
            nowPlayingSection.classList.remove('hidden');
            
            renderFavorites();
        };
        
        audioPlayer.onpause = () => {
            if (audioPlayer.readyState > 0 && !audioPlayer.error && audioPlayer.currentTime > 0) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
                
                renderFavorites();
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    stopPlayback();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    volumeControl.stepUp();
                    audioPlayer.volume = parseFloat(volumeControl.value);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    volumeControl.stepDown();
                    audioPlayer.volume = parseFloat(volumeControl.value);
                    break;
            }
        });

        // --- Initial Load ---

document.addEventListener('DOMContentLoaded', () => {
    loadTheme();
    loadFavorites();
    initializeRadioBrowser(); // Add this line
    
    if (audioPlayer.paused) {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.setAttribute('aria-label', 'Play');
    } else {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        playPauseBtn.setAttribute('aria-label', 'Pause');
    }
    messageBox.classList.add('opacity-0', 'invisible', 'hidden');
});
       
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadFavorites();
            if (audioPlayer.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'Pause');
            }
            messageBox.classList.add('opacity-0', 'invisible', 'hidden');
        });

        // PWA Installation
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker failed: ', err));
            });
        }

        // Install Prompt Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            console.log('PWA installable');
            window.deferredInstallPrompt = e;
            
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.classList.remove('hidden');
                installButton.addEventListener('click', () => {
                    e.prompt();
                    e.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted install');
                            installButton.classList.add('hidden');
                        } else {
                            console.log('User dismissed install');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
