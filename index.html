<!DOCTYPE html>
<html lang="en" class="light">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
   <meta name="version" content="1.3.4">

   <!-- PWA Meta Tags -->
   <meta name="theme-color" content="#111827">
   <meta name="mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-capable" content="yes">
   <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   <meta name="apple-mobile-web-app-title" content="Live Beats">
   
   <!-- Manifest -->
   <link rel="manifest" href="manifest.json" crossorigin="use-credentials">

   <!-- Icons - All paths made relative for GitHub Pages -->
   <link rel="shortcut icon" href="icons/icon-32.png">
   <link rel="icon" href="icons/icon-32.png" sizes="32x32">
   <link rel="icon" href="icons/icon-192.png" sizes="192x192">
   <link rel="apple-touch-icon" href="icons/icon-180.png">
   <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">

   <!-- Windows-specific tags -->
   <meta name="msapplication-TileImage" content="icons/icon-144.png">
   <meta name="msapplication-TileColor" content="#111827">
   <meta name="msapplication-config" content="browserconfig.xml">

<title>Live Beats WebRadio Player</title>
    
<button id="installButton" 
        class="hidden fixed bottom-32 right-4 z-[60] bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-200 flex items-center animate-pulse"
        aria-label="Install Live Beats App">
  <i class="fas fa-download mr-2"></i> Install
</button>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                200: '#bae6fd',
                300: '#7dd3fc',
                400: '#38bdf8',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                800: '#075985',
                900: '#0c4a6e',
              },
            },
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            animation: {
              'spin-slow': 'spin 3s linear infinite',
              'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }
          }
        }
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(156, 163, 175, 0.8);
        }

        .dark ::-webkit-scrollbar-thumb {
            background-color: rgba(75, 85, 99, 0.5);
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background-color: rgba(75, 85, 99, 0.8);
        }

        /* Player controls fixed at bottom */
        .player-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 50;
            backdrop-filter: blur(10px);
            background-color: rgba(255, 255, 255, 0.8);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .dark .player-controls {
            background-color: rgba(17, 24, 39, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Modal styles */
        .modal {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal.open .modal-content {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
        .modal .modal-content {
            transform: translateY(20px) scale(0.98);
            opacity: 0;
        }

        /* Input focus states */
        input:focus, textarea:focus, select:focus, button:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
        .dark input:focus, .dark textarea:focus, .dark select:focus, .dark button:focus-visible {
            outline-color: #60a5fa;
        }

        /* Button styles & hover effects */
        .btn {
            @apply font-medium py-2.5 px-5 rounded-lg shadow-sm transition-all duration-200 ease-in-out transform focus:outline-none;
        }
        .btn-primary {
            @apply btn bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white hover:shadow-md hover:scale-[1.02];
        }
        .btn-secondary {
            @apply btn bg-gray-100 hover:bg-gray-200 text-gray-800 hover:shadow-md hover:scale-[1.02] border border-gray-200;
        }
        .dark .btn-secondary {
            @apply bg-gray-700 hover:bg-gray-600 text-gray-200 border-gray-600;
        }
        
        .btn-danger {
            @apply btn bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .btn-success {
            @apply btn bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .btn-warning {
            @apply btn bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white hover:shadow-md hover:scale-[1.02];
        }
        
        .icon-btn {
            @apply p-2.5 sm:p-3 rounded-full transition-all duration-200 ease-in-out transform hover:scale-105 focus:outline-none;
        }
        .icon-btn:hover {
            @apply bg-gray-100 dark:bg-gray-700;
        }
        .icon-btn:focus-visible {
            @apply ring-2 ring-offset-1 ring-blue-500 dark:ring-blue-400;
        }

        /* Message Box */
        #messageBox {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        #messageBox.opacity-0 {
            transform: translateY(-20px);
        }
        #messageBox.opacity-100 {
            transform: translateY(0);
        }
        
        /* Station card hover effect */
        .station-card {
            @apply transition-all duration-200 ease-in-out transform hover:-translate-y-0.5;
        }
        
        /* Volume slider */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            @apply bg-gray-200 dark:bg-gray-600;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            @apply bg-blue-500 dark:bg-blue-400 cursor-pointer;
        }
        
        /* Loading spinner */
        .spinner {
            animation: spin-slow 1.5s linear infinite;
        }
        
        /* Now playing animation */
        @keyframes nowPlaying {
            0%, 100% { opacity: 0.5; transform: scale(0.95); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        .now-playing {
            animation: nowPlaying 2s ease-in-out infinite;
        }
        
        /* Gradient text */
        .gradient-text {
            @apply bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400;
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        /* Pulse animation for live indicator */
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .live-indicator {
            animation: livePulse 2s ease-in-out infinite;
        }
        
        /* Waveform animation */
        .waveform {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 40px;
            height: 20px;
        }
        
        .waveform-bar {
            background-color: currentColor;
            width: 3px;
            border-radius: 3px;
            animation: waveformAnimation 1.5s ease-in-out infinite;
        }
        
        .waveform-bar:nth-child(1) {
            height: 30%;
            animation-delay: 0.1s;
        }
        
        .waveform-bar:nth-child(2) {
            height: 60%;
            animation-delay: 0.3s;
        }
        
        .waveform-bar:nth-child(3) {
            height: 40%;
            animation-delay: 0.5s;
        }
        
        .waveform-bar:nth-child(4) {
            height: 80%;
            animation-delay: 0.2s;
        }
        
        .waveform-bar:nth-child(5) {
            height: 50%;
            animation-delay: 0.4s;
        }
        
        @keyframes waveformAnimation {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.2); }
        }

           /* Radio Browser Styles */
#radioBrowserResults::-webkit-scrollbar {
    width: 6px;
}

#radioBrowserResults {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
}

.dark #radioBrowserResults {
    scrollbar-color: rgba(75, 85, 99, 0.5) transparent;
}

.popular-tag-btn {
    transition: all 0.2s ease;
}

.popular-tag-btn:hover {
    transform: translateY(-1px);
}
           
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">

    <audio id="audioPlayer"></audio>

    <header class="bg-white dark:bg-gray-800 shadow-sm p-4 sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center max-w-6xl px-4">
            <div class="flex items-center space-x-2">
               <img src="icons/icon-48.png" 
     alt="Live Beats Icon" 
     class="w-8 h-8 rounded-lg">
                <h1 class="text-xl sm:text-2xl font-bold gradient-text">
                    Live Beats WebRadio
                </h1>
            </div>
            
            <div class="flex items-center space-x-4">
                <button id="themeToggleBtn" class="icon-btn text-gray-600 dark:text-gray-300">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                
                <button id="infoBtn" class="icon-btn text-gray-600 dark:text-gray-300" aria-label="App Info">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto max-w-6xl p-4 flex-grow mb-36">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Play from URL section -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-link mr-2 text-blue-500"></i>
                        Play from URL
                    </h2>
                    <div class="flex flex-col sm:flex-row items-stretch gap-3">
                        <input type="url" id="directUrlInput" 
                               class="flex-grow w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                               placeholder="https://example.com/stream.mp3">
                        <button id="playDirectUrlBtn" class="btn-primary whitespace-nowrap">
                            <i class="fas fa-play mr-2"></i>Play
                        </button>
                    </div>
                    <div class="mt-3 text-sm text-gray-500 dark:text-gray-400">
                        Tip: If the station will not play it likely doesn't support CORS
                    </div>
                </div>

               <!-- Radio Browser section -->
<div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
    <h2 class="text-xl font-semibold mb-4 flex items-center">
        <i class="fas fa-search mr-2 text-blue-500"></i>
        Discover Stations
    </h2>
    
    <div class="flex flex-col sm:flex-row items-stretch gap-3 mb-4">
        <input type="text" id="radioSearchInput" 
               class="flex-grow w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
               placeholder="Search for stations...">
        <button id="radioSearchBtn" class="btn-primary whitespace-nowrap">
            <i class="fas fa-search mr-2"></i>Search
        </button>
    </div>
    
    <div class="flex flex-wrap gap-2 mb-4">
        <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="topclick">Popular</button>
        <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="topvote">Top Rated</button>
        
        <button class="popular-tag-btn btn-secondary text-sm px-3 py-1" data-tag="genre">By Genre</button>
    </div>
    
    <div id="radioBrowserResults" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 hidden">
        <!-- Results will be displayed here -->
    </div>
    
    <div id="radioBrowserLoading" class="text-center py-4 hidden">
        <i class="fas fa-spinner spinner text-blue-500 text-2xl"></i>
        <p class="text-gray-500 dark:text-gray-400 mt-2">Loading stations...</p>
    </div>
    
    <div id="radioBrowserEmpty" class="text-center py-4">
        <i class="fas fa-radio text-3xl text-gray-300 dark:text-gray-600 mb-3"></i>
        <p class="text-gray-500 dark:text-gray-400">Search for radio stations to discover</p>
    </div>
</div>
                
                <!-- Quick Access section -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-bolt mr-2 text-amber-500"></i>
                            Quick Access
                        </h2>
                        <button id="editQuickAccessBtn" class="icon-btn text-gray-500 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div id="quickAccessList" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <!-- Quick access buttons will be generated here -->
                    </div>
                </div>
            </div>
            
            <!-- Right column -->
            <div class="space-y-6">
                <!-- Actions section -->
                <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-cog mr-2 text-gray-500"></i>
                        Actions
                    </h2>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="openAddModalBtn" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Add
                        </button>
                        <button id="importFavoritesBtn" class="btn-warning">
                            <i class="fas fa-file-import mr-2"></i>Import
                        </button>
                        <button id="exportFavoritesBtn" class="btn-success">
                            <i class="fas fa-file-export mr-2"></i>Export
                        </button>
                        <button id="clearFavoritesBtn" class="btn-danger">
                            <i class="fas fa-trash mr-2"></i>Clear
                        </button>
                    </div>
                </div>
                
                <!-- Now Playing section -->
                <div id="nowPlayingSection" class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 hidden">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-headphones mr-2 text-purple-500"></i>
                        Now Playing
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white">
                                <i class="fas fa-music text-2xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="text-sm text-gray-500 dark:text-gray-400 truncate">Station</p>
                            <p id="currentStationName" class="font-bold truncate" title="No station selected">---</p>
                            <div class="flex items-center mt-1">
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 mr-2">
                                    <span class="w-2 h-2 rounded-full bg-red-500 mr-1 live-indicator"></span>
                                    LIVE
                                </span>
                                <span id="bitrateInfo" class="text-xs text-gray-500 dark:text-gray-400"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Favorites section -->
        <div class="mt-6 bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-star mr-2 text-yellow-500"></i>
                    My Favorite Stations
                </h2>
                <span id="favoritesCount" class="text-sm bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-2.5 py-0.5 rounded-full">
                    0 stations
                </span>
            </div>
            
            <div id="favoritesList" class="space-y-3 max-h-[50vh] overflow-y-auto pr-2">
                <div id="noFavoritesMsg" class="text-center py-8">
                    <i class="fas fa-radio text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400">No favorite stations yet.</p>
                    <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">Add some stations or try the quick access links!</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Player controls -->
    <div class="player-controls">
        <div class="container mx-auto max-w-6xl flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0 p-4">
            <div class="w-full sm:w-auto flex items-center space-x-3 text-center sm:text-left mb-2 sm:mb-0 min-w-0">
                <div class="flex-grow min-w-0">
                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 truncate">Now Playing:</p>
                    <p id="currentStationNameCompact" class="font-semibold truncate text-base sm:text-lg" title="No station selected">---</p>
                </div>
                <button id="addCurrentToFavoritesBtn" class="icon-btn text-yellow-500 dark:text-yellow-400 hidden text-lg" title="Add current station to favorites" aria-label="Add to favorites">
                    <i class="fas fa-star"></i>
                </button>
            </div>

            <div class="flex items-center space-x-4">
                <button id="stopBtn" class="icon-btn text-2xl sm:text-3xl text-red-500 dark:text-red-400" aria-label="Stop">
                    <i class="fas fa-stop"></i>
                </button>
            <button id="playPauseBtn" class="icon-btn text-3xl sm:text-4xl text-green-500 hover:text-green-600 dark:text-green-400 dark:hover:text-green-300" aria-label="Play">
    <i class="fas fa-play"></i>
</button>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-volume-down text-gray-600 dark:text-gray-300 text-base sm:text-lg"></i>
                   <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="0.5" 
       class="w-32 sm:w-40 h-2 bg-gray-200 dark:bg-gray-600 rounded-full appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-blue-500 dark:[&::-webkit-slider-thumb]:bg-blue-400">
                    <i class="fas fa-volume-up text-gray-600 dark:text-gray-300 text-base sm:text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Station Modal -->
    <div id="stationModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 id="modalTitle" class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-plus-circle mr-2 text-blue-500"></i>
                <span>Add Favorite Station</span>
            </h3>
            <form id="stationForm">
                <input type="hidden" id="stationId">
                <div class="mb-4">
                    <label for="stationNameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Station Name</label>
                    <input type="text" id="stationNameInput" required 
                           class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                           placeholder="E.g., My Favorite Hits">
                </div>
                <div class="mb-6">
                    <label for="stationUrlInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Station Stream URL</label>
                    <input type="url" id="stationUrlInput" required 
                           class="w-full px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white placeholder-gray-400 dark:placeholder-gray-500" 
                           placeholder="https://stream.example.com/radio">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelModalBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="saveStationBtn" class="btn-primary">Save Station</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Access Edit Modal -->
    <div id="quickAccessEditModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-edit mr-2 text-blue-500"></i>
                <span>Edit Quick Access</span>
            </h3>
            <div class="mb-6">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Select stations to show in Quick Access:</p>
                <div id="quickAccessEditList" class="space-y-2 max-h-[300px] overflow-y-auto">
                    <!-- Favorites will be listed here for selection -->
                </div>
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelQuickAccessEditBtn" class="btn-secondary">Cancel</button>
                <button type="button" id="saveQuickAccessEditBtn" class="btn-primary">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-5 flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                <span>About Live Beats WRP</span>
            </h3>
            <div class="space-y-4 text-sm text-gray-700 dark:text-gray-300">
                <p>
              <strong>License:</strong> GNU GPL v3<br>
    <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" 
       target="_blank" 
       rel="noopener noreferrer"
       class="text-blue-600 dark:text-blue-400 hover:underline">
       View License Terms
    </a>
  </p>

 <p>
  <strong>©2025 <span id="currentYear"></span> Christian Flach</strong><br>
  <a href="mailto:your.email@example.com" 
     class="text-blue-600 dark:text-blue-400 hover:underline">
     Contact: livebeatswrp@gmail.com
  </a><br>
  <a href="https://lbwebradio.github.io/index.html"
     target="_blank"
     rel="noopener noreferrer"
     class="text-blue-600 dark:text-blue-400 hover:underline">
     LBWRP Website
  </a>
</p>

  <p class="text-sm">
    <strong>Version:</strong> 1.3.4
</p>
               
            </div>
            <div class="mt-6 flex justify-end">
                <button type="button" id="closeInfoModalBtn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Confirmation Modal -->
    <div id="importConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Import Stations</h3>
            <p id="importConfirmText" class="mb-6">You're about to import stations. Existing stations with the same URL will be updated.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelImportBtn" class="btn-secondary">Cancel</button>
                <button id="confirmImportBtn" class="btn-primary">Import</button>
            </div>
        </div>
    </div>

    <!-- Clear Confirmation Modal -->
    <div id="clearConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 opacity-0 invisible z-[100]">
        <div class="modal-content bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Clear All Favorites</h3>
            <p class="mb-6 text-red-500 dark:text-red-400">Are you sure you want to delete all your favorite stations? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClearBtn" class="btn-secondary">Cancel</button>
                <button id="confirmClearBtn" class="btn-danger">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white opacity-0 invisible z-[150] max-w-xs sm:max-w-sm text-sm border border-transparent">
        <div class="flex items-start justify-between">
            <div class="flex-shrink-0 pt-0.5">
                <i id="messageIcon" class="fas fa-info-circle mr-3"></i>
            </div>
            <div class="flex-grow">
                <p id="messageText" class="mr-2"></p>
            </div>
            <button id="closeMessageBtn" class="text-lg font-bold leading-none hover:opacity-75 focus:outline-none">&times;</button>
        </div>
    </div>

    <!-- File Input (hidden) -->
    <input type="file" id="fileImportInput" accept=".lbrx" class="hidden">

    <script>
        // DOM Elements
        const audioPlayer = document.getElementById('audioPlayer');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const infoBtn = document.getElementById('infoBtn');
        const openAddModalBtn = document.getElementById('openAddModalBtn');
        const stationModal = document.getElementById('stationModal');
        const quickAccessEditModal = document.getElementById('quickAccessEditModal');
        const infoModal = document.getElementById('infoModal');
        const importConfirmModal = document.getElementById('importConfirmModal');
        const clearConfirmModal = document.getElementById('clearConfirmModal');
        const modalTitle = document.getElementById('modalTitle');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
        const stationForm = document.getElementById('stationForm');
        const stationIdInput = document.getElementById('stationId');
        const stationNameInput = document.getElementById('stationNameInput');
        const stationUrlInput = document.getElementById('stationUrlInput');
        const favoritesList = document.getElementById('favoritesList');
        const noFavoritesMsg = document.getElementById('noFavoritesMsg');
        const favoritesCount = document.getElementById('favoritesCount');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const volumeControl = document.getElementById('volumeControl');
        const currentStationName = document.getElementById('currentStationName');
        const currentStationNameCompact = document.getElementById('currentStationNameCompact');
        const nowPlayingSection = document.getElementById('nowPlayingSection');
        const bitrateInfo = document.getElementById('bitrateInfo');
        const quickAccessList = document.getElementById('quickAccessList');
        const quickAccessEditList = document.getElementById('quickAccessEditList');
        const editQuickAccessBtn = document.getElementById('editQuickAccessBtn');
        const cancelQuickAccessEditBtn = document.getElementById('cancelQuickAccessEditBtn');
        const saveQuickAccessEditBtn = document.getElementById('saveQuickAccessEditBtn');
        
        // Direct URL play elements
        const directUrlInput = document.getElementById('directUrlInput');
        const playDirectUrlBtn = document.getElementById('playDirectUrlBtn');
        const addCurrentToFavoritesBtn = document.getElementById('addCurrentToFavoritesBtn');

        // Import/Export Elements
        const importFavoritesBtn = document.getElementById('importFavoritesBtn');
        const exportFavoritesBtn = document.getElementById('exportFavoritesBtn');
        const clearFavoritesBtn = document.getElementById('clearFavoritesBtn');
        const fileImportInput = document.getElementById('fileImportInput');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importConfirmText = document.getElementById('importConfirmText');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        const confirmClearBtn = document.getElementById('confirmClearBtn');

        // Message Box Elements
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageIcon = document.getElementById('messageIcon');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        let messageTimeout;

        let favorites = [];
        let quickAccessStations = [];
        let currentPlayingStation = null;
        let isDirectUrlStream = false;
        let currentLbrxFileName = 'live_beats_favorites.lbrx';
        let audioContext;
        let analyser;
        let bitrateInterval;
        let lastBytes = 0;
       // ====================
// Radio Browser Section
// ====================

// Radio Browser API elements
const radioSearchInput = document.getElementById('radioSearchInput');
const radioSearchBtn = document.getElementById('radioSearchBtn');
const radioBrowserResults = document.getElementById('radioBrowserResults');
const radioBrowserLoading = document.getElementById('radioBrowserLoading');
const radioBrowserEmpty = document.getElementById('radioBrowserEmpty');
const popularTagBtns = document.querySelectorAll('.popular-tag-btn');

// Radio Browser API configuration
const RADIO_BROWSER_USER_AGENT = 'Live Beats WebRadio PWA/1.3.4';
let RADIO_BROWSER_BASE_URL = 'https://de1.api.radio-browser.info';

// Current search state
let currentRadioSearch = '';
let currentRadioResults = [];

// Function to get a random available server
async function getRandomRadioBrowserServer() {
    try {
        const response = await fetch('https://all.api.radio-browser.info/json/servers', {
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        
        if (!response.ok) throw new Error('Failed to fetch servers');
        
        const servers = await response.json();
        const httpsServers = servers.map(server => `https://${server.name}`);
        return httpsServers[Math.floor(Math.random() * httpsServers.length)];
    } catch (error) {
        console.error('Error getting random server, using fallback:', error);
        return 'https://de1.api.radio-browser.info'; // Fallback
    }
}

// Initialize with a random server
async function initializeRadioBrowser() {
    RADIO_BROWSER_BASE_URL = await getRandomRadioBrowserServer();
    console.log('Using Radio Browser server:', RADIO_BROWSER_BASE_URL);
    
    // Load popular stations initially
    searchRadioStations('topclick', 'tag');
}

// Track station click in Radio Browser API
async function trackStationClick(stationUuid) {
    if (!stationUuid) return;
    
    try {
        const url = `${RADIO_BROWSER_BASE_URL}/json/url/${stationUuid}`;
        await fetch(url, {
            method: 'POST',
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        console.log('Station click tracked:', stationUuid);
    } catch (error) {
        console.error('Error tracking station click:', error);
    }
}

// Search radio stations
async function searchRadioStations(searchTerm = '', searchBy = 'name') {
    try {
        // Show loading state
        radioBrowserResults.classList.add('hidden');
        radioBrowserEmpty.classList.add('hidden');
        radioBrowserLoading.classList.remove('hidden');
        
        let apiUrl;
        
        if (searchBy === 'tag') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/${searchTerm}?hidebroken=true&limit=30`;
        } else if (searchBy === 'country') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/bycountry/${encodeURIComponent(searchTerm)}?hidebroken=true&limit=30`;
        } else if (searchBy === 'genre') {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/bytagexact/${encodeURIComponent(searchTerm)}?hidebroken=true&limit=30`;
        } else {
            apiUrl = `${RADIO_BROWSER_BASE_URL}/json/stations/search?name=${encodeURIComponent(searchTerm)}&hidebroken=true&limit=30`;
        }
        
        const response = await fetch(apiUrl, {
            headers: {
                'User-Agent': RADIO_BROWSER_USER_AGENT
            }
        });
        
        if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
        
        const data = await response.json();
        currentRadioResults = data;
        renderRadioBrowserResults(data);
        
        radioBrowserLoading.classList.add('hidden');
        
        if (data.length > 0) {
            radioBrowserResults.classList.remove('hidden');
            radioBrowserEmpty.classList.add('hidden');
        } else {
            radioBrowserResults.classList.add('hidden');
            radioBrowserEmpty.classList.remove('hidden');
            radioBrowserEmpty.innerHTML = `
                <i class="fas fa-exclamation-circle text-3xl text-gray-300 dark:text-gray-600 mb-3"></i>
                <p class="text-gray-500 dark:text-gray-400">No stations found</p>
            `;
        }
    } catch (error) {
        console.error('Radio Browser API error:', error);
        radioBrowserLoading.classList.add('hidden');
        radioBrowserResults.classList.add('hidden');
        radioBrowserEmpty.classList.remove('hidden');
        radioBrowserEmpty.innerHTML = `
            <i class="fas fa-exclamation-triangle text-3xl text-red-300 dark:text-red-600 mb-3"></i>
            <p class="text-gray-500 dark:text-gray-400">Failed to load stations</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">${error.message}</p>
        `;
        
        // Try to recover by getting a new server
        RADIO_BROWSER_BASE_URL = await getRandomRadioBrowserServer();
    }
}

// Render radio browser results
function renderRadioBrowserResults(stations) {
    radioBrowserResults.innerHTML = '';
    
    stations.forEach(station => {
        let streamUrl = station.url_resolved || station.url;
        if (!streamUrl) return;
        
        const div = document.createElement('div');
        div.className = 'station-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 dark:border-gray-600';
        
        const leftDiv = document.createElement('div');
        leftDiv.className = 'flex items-center min-w-0 flex-grow';
        
        const favicon = document.createElement('img');
        favicon.className = 'w-8 h-8 rounded mr-3 flex-shrink-0';
        // Set default image first
        favicon.src = 'icons/icon-32.png';
        
        // Only try to load station favicon if it exists and isn't empty
        if (station.favicon && station.favicon.trim() !== '') {
            // Create a temporary image to test loading
            const tempImg = new Image();
            tempImg.onload = function() {
                favicon.src = station.favicon;
            };
            tempImg.onerror = function() {
                // Keep the default image if loading fails
                // Already set to default, so no need to do anything
            };
            // Start loading the image
            tempImg.src = station.favicon;
        }
        
        favicon.alt = station.name;
        
        // Rest of the function remains the same...
        const infoDiv = document.createElement('div');
        infoDiv.className = 'min-w-0';
        
        const nameSpan = document.createElement('span');
        nameSpan.className = 'font-medium block truncate';
        nameSpan.textContent = station.name;
        
        const metaDiv = document.createElement('div');
        metaDiv.className = 'flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400 mt-1';
        
        const countrySpan = document.createElement('span');
        countrySpan.textContent = station.country || 'Unknown';
        
        const genreSpan = document.createElement('span');
        genreSpan.textContent = station.tags || station.genre || 'Various';
        genreSpan.className = 'truncate';
        
        metaDiv.appendChild(countrySpan);
        metaDiv.appendChild(document.createTextNode('•'));
        metaDiv.appendChild(genreSpan);
        
        infoDiv.appendChild(nameSpan);
        infoDiv.appendChild(metaDiv);
        leftDiv.appendChild(favicon);
        leftDiv.appendChild(infoDiv);
        
        const playBtn = document.createElement('button');
        playBtn.className = 'icon-btn text-blue-500 dark:text-blue-400 hover:text-blue-600 dark:hover:text-blue-300';
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
        playBtn.title = `Play ${station.name}`;
        playBtn.addEventListener('click', () => {
            // Track the click first
            trackStationClick(station.stationuuid);
            
            playStation({
                id: `radio_browser_${station.stationuuid}`,
                name: station.name,
                url: streamUrl
            }, true);
            
            document.querySelector('#nowPlayingSection').scrollIntoView({
                behavior: 'smooth'
            });
        });
        
        const addBtn = document.createElement('button');
        addBtn.className = 'icon-btn text-yellow-500 dark:text-yellow-400 hover:text-yellow-600 dark:hover:text-yellow-300';
        addBtn.innerHTML = '<i class="fas fa-star"></i>';
        addBtn.title = `Add ${station.name} to favorites`;
        addBtn.addEventListener('click', () => {
            openModal('add', {
                name: station.name,
                url: streamUrl
            });
        });
        
        div.appendChild(leftDiv);
        div.appendChild(playBtn);
        div.appendChild(addBtn);
        radioBrowserResults.appendChild(div);
    });
}

// Event listeners for radio browser
radioSearchBtn.addEventListener('click', () => {
    const searchTerm = radioSearchInput.value.trim();
    if (searchTerm) {
        currentRadioSearch = searchTerm;
        searchRadioStations(searchTerm);
    }
});

radioSearchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        const searchTerm = radioSearchInput.value.trim();
        if (searchTerm) {
            currentRadioSearch = searchTerm;
            searchRadioStations(searchTerm);
        }
    }
});

popularTagBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        const tag = btn.dataset.tag;
        radioSearchInput.value = '';
        
        // Remove the country case
        if (tag === 'genre') {
            const genre = prompt('Enter genre (e.g., rock, jazz, pop):');
            if (genre) {
                searchRadioStations(genre, 'genre');
            }
        } else {
            searchRadioStations(tag, 'tag');
        }
    });
});

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeRadioBrowser);

        // Default quick access stations
        const defaultQuickAccessStations = [
            { name: "BBC Radio 1", url: "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one", icon: "fab fa-bbc" },
            { name: "BBC Radio 2", url: "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_two", icon: "fab fa-bbc" },
            { name: "Classic FM", url: "https://icecast.thisisdax.com/ClassicFMMP3", icon: "fas fa-music" },
            { name: "Radio Swiss Jazz", url: "https://stream.srg-ssr.ch/m/rsj/mp3_128", icon: "fas fa-globe-europe" },
            { name: "Radio France", url: "https://stream.srg-ssr.ch/m/rsj/mp3_128", icon: "fas fa-broadcast-tower" },
            { name: "Radio Paradise", url: "https://stream.radioparadise.com/flac", icon: "fas fa-parachute-box" }
        ];

        // --- Message Box Logic ---
function showMessage(message, type = 'info', duration = 3000) {
    // Clear any existing message
    messageText.textContent = message;
    messageBox.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white opacity-0 invisible z-[150] max-w-xs sm:max-w-sm text-sm border border-transparent';
    
    // Set colors based on type (NO SPACES IN CLASS LISTS!)
    const colorClasses = {
        success: ['bg-green-600', 'border-green-700'],
        error: ['bg-red-600', 'border-red-700'],
        warning: ['bg-amber-500', 'border-amber-600'],
        info: ['bg-blue-600', 'border-blue-700']
    };
    
    // Add each class individually
    colorClasses[type].forEach(cls => messageBox.classList.add(cls));
    
    // Set icon
    messageIcon.className = `fas ${
        type === 'success' ? 'fa-check-circle' :
        type === 'error' ? 'fa-exclamation-circle' :
        type === 'warning' ? 'fa-exclamation-triangle' :
        'fa-info-circle'
    } mr-3`;
    
    // Show message
    messageBox.classList.remove('invisible', 'opacity-0');
    messageBox.classList.add('opacity-100', 'animate-fade-in');
    
    // Auto-hide
    clearTimeout(messageTimeout);
    messageTimeout = setTimeout(hideMessage, duration);
}

        function hideMessage() {
            messageBox.classList.remove('opacity-100');
            messageBox.classList.add('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('invisible');
            }, 300);
        }
        closeMessageBtn.addEventListener('click', hideMessage);

        // --- Theme Management ---
        function setLightTheme() {
            document.documentElement.classList.remove('dark');
            document.documentElement.classList.add('light');
            localStorage.setItem('theme', 'light');
        }

        function setDarkTheme() {
            document.documentElement.classList.add('dark');
            document.documentElement.classList.remove('light');
            localStorage.setItem('theme', 'dark');
        }

        themeToggleBtn.addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                setLightTheme();
            } else {
                setDarkTheme();
            }
        });

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                setDarkTheme();
            } else {
                setLightTheme();
            }
        }

        // --- Modal Management ---
        function openModal(mode = 'add', station = null) {
            stationModal.classList.remove('invisible', 'opacity-0');
            stationModal.classList.add('open');
            stationForm.reset();
            stationIdInput.value = '';

            if (mode === 'edit' && station) {
                modalTitle.innerHTML = '<i class="fas fa-edit mr-2 text-blue-500"></i><span>Edit Favorite Station</span>';
                stationIdInput.value = station.id;
                stationNameInput.value = station.name;
                stationUrlInput.value = station.url;
            } else {
                modalTitle.innerHTML = '<i class="fas fa-plus-circle mr-2 text-blue-500"></i><span>Add Favorite Station</span>';
                if (station && station.url) {
                    stationUrlInput.value = station.url;
                    if (station.name && station.name !== "Direct Stream" && !station.name.startsWith("http")) {
                        stationNameInput.value = station.name;
                    } else {
                        try {
                            const urlObj = new URL(station.url);
                            stationNameInput.value = urlObj.hostname.replace(/^www\./, '');
                        } catch (e) {
                            stationNameInput.value = '';
                        }
                    }
                }
            }
            stationNameInput.focus();
        }

        function closeModal() {
            stationModal.classList.add('opacity-0');
            setTimeout(() => {
                stationModal.classList.add('invisible');
                stationModal.classList.remove('open');
            }, 200);
        }

        function openQuickAccessEditModal() {
            quickAccessEditList.innerHTML = '';
            
            // Add favorites to the edit list
            favorites.forEach(station => {
                const isInQuickAccess = quickAccessStations.some(q => q.url === station.url);
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded-lg';
                
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 cursor-pointer';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'rounded text-blue-600 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-600';
                checkbox.checked = isInQuickAccess;
                checkbox.dataset.url = station.url;
                checkbox.dataset.name = station.name;
                
                const span = document.createElement('span');
                span.className = 'text-sm font-medium text-gray-700 dark:text-gray-300';
                span.textContent = station.name;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                div.appendChild(label);
                
                quickAccessEditList.appendChild(div);
            });
            
            quickAccessEditModal.classList.remove('invisible', 'opacity-0');
            quickAccessEditModal.classList.add('open');
        }

        function closeQuickAccessEditModal() {
            quickAccessEditModal.classList.add('opacity-0');
            setTimeout(() => {
                quickAccessEditModal.classList.add('invisible');
                quickAccessEditModal.classList.remove('open');
            }, 200);
        }

        function openInfoModal() {
            infoModal.classList.remove('invisible', 'opacity-0');
            infoModal.classList.add('open');
        }

        function closeInfoModal() {
            infoModal.classList.add('opacity-0');
            setTimeout(() => {
                infoModal.classList.add('invisible');
                infoModal.classList.remove('open');
            }, 200);
        }

        function openImportConfirmModal(stationCount) {
            importConfirmText.textContent = `You're about to import ${stationCount} stations. Existing stations with the same URL will be updated.`;
            importConfirmModal.classList.remove('invisible', 'opacity-0');
            importConfirmModal.classList.add('open');
        }

        function closeImportConfirmModal() {
            importConfirmModal.classList.add('opacity-0');
            setTimeout(() => {
                importConfirmModal.classList.add('invisible');
                importConfirmModal.classList.remove('open');
            }, 200);
        }

        function openClearConfirmModal() {
            clearConfirmModal.classList.remove('invisible', 'opacity-0');
            clearConfirmModal.classList.add('open');
        }

        function closeClearConfirmModal() {
            clearConfirmModal.classList.add('opacity-0');
            setTimeout(() => {
                clearConfirmModal.classList.add('invisible');
                clearConfirmModal.classList.remove('open');
            }, 200);
        }

        openAddModalBtn.addEventListener('click', () => openModal('add'));
        editQuickAccessBtn.addEventListener('click', openQuickAccessEditModal);
        cancelQuickAccessEditBtn.addEventListener('click', closeQuickAccessEditModal);
        infoBtn.addEventListener('click', openInfoModal);
        closeInfoModalBtn.addEventListener('click', closeInfoModal);
        cancelModalBtn.addEventListener('click', closeModal);
        
        stationModal.addEventListener('click', (e) => {
            if (e.target === stationModal) closeModal();
        });
        
        quickAccessEditModal.addEventListener('click', (e) => {
            if (e.target === quickAccessEditModal) closeQuickAccessEditModal();
        });
        
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) closeInfoModal();
        });
        
        importConfirmModal.addEventListener('click', (e) => {
            if (e.target === importConfirmModal) closeImportConfirmModal();
        });
        
        clearConfirmModal.addEventListener('click', (e) => {
            if (e.target === clearConfirmModal) closeClearConfirmModal();
        });

        // Save quick access changes
        saveQuickAccessEditBtn.addEventListener('click', () => {
            const checkboxes = quickAccessEditList.querySelectorAll('input[type="checkbox"]:checked');
            const newQuickAccess = [];
            
            checkboxes.forEach(checkbox => {
                newQuickAccess.push({
                    name: checkbox.dataset.name,
                    url: checkbox.dataset.url
                });
            });
            
            // If no stations selected, keep at least one default
            if (newQuickAccess.length === 0) {
                newQuickAccess.push(defaultQuickAccessStations[0]);
                showMessage('At least one station must be in Quick Access. Kept first default station.', 'info');
            }
            
            quickAccessStations = newQuickAccess;
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            renderQuickAccess();
            closeQuickAccessEditModal();
            showMessage('Quick Access updated!', 'success');
        });

        // --- Favorites Management ---
        function loadFavorites() {
            const storedFavorites = localStorage.getItem('radioFavorites');
            favorites = storedFavorites ? JSON.parse(storedFavorites) : [];
            
            const storedQuickAccess = localStorage.getItem('quickAccessStations');
            quickAccessStations = storedQuickAccess ? JSON.parse(storedQuickAccess) : defaultQuickAccessStations;
            
            const storedFilename = localStorage.getItem('currentLbrxFileName');
            if (storedFilename) currentLbrxFileName = storedFilename;
            
            renderFavorites();
            renderQuickAccess();
            updateFavoritesCount();
        }

        function saveFavorites() {
            localStorage.setItem('radioFavorites', JSON.stringify(favorites));
            updateLBRXFile();
            renderFavorites();
            renderQuickAccess();
            updateFavoritesCount();
        }

        function updateFavoritesCount() {
            const count = favorites.length;
            favoritesCount.textContent = `${count} station${count !== 1 ? 's' : ''}`;
        }

        function updateLBRXFile() {
            let lbrxContent = generateLBRXContent();
            localStorage.setItem('radioFavoritesLBRX', lbrxContent);
        }

      function generateLBRXContent() {
    let content = "## LIVE BEATS WEBRADIO PLAYER EXPORT ##\n";
    content += `## Date: ${new Date().toISOString()}\n`;
    content += `## Version: 1.3.4\n`;
    content += `=== FAVORITE STATIONS (${favorites.length} stations) ===\n\n`;
    
    // Add numbered stations with exact WinForms formatting
    favorites.forEach((station, index) => {
        content += `${index + 1}. ${station.name}\n${station.url}\n\n`;
    });
    
    content += "## END OF EXPORT ##";
    return content;
}

        function renderQuickAccess() {
            quickAccessList.innerHTML = '';
            
            quickAccessStations.forEach(station => {
                const button = document.createElement('button');
                button.className = 'quick-access-btn btn-secondary text-left truncate';
                button.dataset.url = station.url;
                button.dataset.name = station.name;
                
                // Try to find icon from default stations
                const defaultStation = defaultQuickAccessStations.find(s => s.url === station.url);
                const iconClass = defaultStation ? defaultStation.icon : 'fas fa-radio';
                
                button.innerHTML = `
                    <i class="${iconClass} mr-2"></i>
                    <span class="truncate">${station.name}</span>
                `;
                
                button.addEventListener('click', () => {
                    directUrlInput.value = station.url;
                    playStation({ 
                        id: 'quick_' + Date.now(), 
                        name: station.name, 
                        url: station.url 
                    }, true);
                });
                
                quickAccessList.appendChild(button);
            });
        }

        function renderFavorites() {
           console.log('Rendering favorites:', favorites); 
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                noFavoritesMsg.style.display = 'block';
            } else {
                noFavoritesMsg.style.display = 'none';
                
                favorites.forEach((station, index) => {
                    const isPlaying = currentPlayingStation && currentPlayingStation.id === station.id;
                    const isInQuickAccess = quickAccessStations.some(q => q.url === station.url);
                    
                    const div = document.createElement('div');
                    div.className = `station-card flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200 dark:border-gray-600 ${isPlaying ? 'border-blue-500 dark:border-blue-400' : ''}`;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.className = 'flex items-center min-w-0 flex-grow';
                    
                    const numberSpan = document.createElement('span');
                    numberSpan.className = 'text-gray-500 dark:text-gray-400 text-sm font-medium mr-3 w-5 text-right';
                    numberSpan.textContent = `${index + 1}.`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = station.name;
                    nameSpan.className = 'font-medium cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 flex-grow truncate mr-2 text-sm sm:text-base';
                    nameSpan.title = `Play ${station.name}`;
                    nameSpan.addEventListener('click', () => playStation(station, false));
                    
                    leftDiv.appendChild(numberSpan);
                    leftDiv.appendChild(nameSpan);
                    
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'flex items-center space-x-1 sm:space-x-2 flex-shrink-0';
                    
                    if (isPlaying) {
                        const playingIndicator = document.createElement('div');
                        playingIndicator.className = 'waveform text-blue-500 dark:text-blue-400 mr-1';
                        playingIndicator.innerHTML = `
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                            <div class="waveform-bar"></div>
                        `;
                        controlsDiv.appendChild(playingIndicator);
                    }
                    
                    // Add to quick access button
                    const quickAccessBtn = document.createElement('button');
                    quickAccessBtn.className = `icon-btn ${isInQuickAccess ? 'text-yellow-500 dark:text-yellow-400' : 'text-gray-400 dark:text-gray-500'}`;
                    quickAccessBtn.innerHTML = '<i class="fas fa-bolt"></i>';
                    quickAccessBtn.title = isInQuickAccess ? 'Remove from Quick Access' : 'Add to Quick Access';
                    quickAccessBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleQuickAccessStation(station);
                    });
                    
                    const playBtnItem = document.createElement('button');
                    playBtnItem.className = `icon-btn ${isPlaying ? 'text-blue-500 dark:text-blue-400' : 'text-gray-500 dark:text-gray-400'}`;
                    playBtnItem.innerHTML = `<i class="fas fa-${isPlaying ? 'pause' : 'play'}"></i>`;
                    playBtnItem.title = isPlaying ? `Pause ${station.name}` : `Play ${station.name}`;
                    playBtnItem.setAttribute('aria-label', isPlaying ? `Pause ${station.name}` : `Play ${station.name}`);
                    playBtnItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (isPlaying && !audioPlayer.paused) {
                            audioPlayer.pause();
                        } else {
                            playStation(station, false);
                        }
                    });
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'icon-btn text-gray-500 dark:text-gray-400 hover:text-yellow-500 dark:hover:text-yellow-400';
                    editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = `Edit ${station.name}`;
                    editBtn.setAttribute('aria-label', `Edit ${station.name}`);
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openModal('edit', station);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'icon-btn text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.title = `Delete ${station.name}`;
                    deleteBtn.setAttribute('aria-label', `Delete ${station.name}`);
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteFavorite(station.id);
                    });
                    
                    controlsDiv.appendChild(quickAccessBtn);
                    controlsDiv.appendChild(playBtnItem);
                    controlsDiv.appendChild(editBtn);
                    controlsDiv.appendChild(deleteBtn);
                    
                    div.appendChild(leftDiv);
                    div.appendChild(controlsDiv);
                    favoritesList.appendChild(div);
                });
            }
        }

        function toggleQuickAccessStation(station) {
            const index = quickAccessStations.findIndex(q => q.url === station.url);
            
            if (index > -1) {
                // Remove from quick access
                quickAccessStations.splice(index, 1);
                showMessage(`Removed "${station.name}" from Quick Access`, 'info');
            } else {
                // Add to quick access
                quickAccessStations.push({
                    name: station.name,
                    url: station.url
                });
                showMessage(`Added "${station.name}" to Quick Access`, 'success');
            }
            
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            renderQuickAccess();
            renderFavorites();
        }

        stationForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = stationIdInput.value;
            const name = stationNameInput.value.trim();
            const url = stationUrlInput.value.trim();

            if (!name || !url) {
                showMessage('Station Name and URL are required.', 'error');
                return;
            }

            try {
                new URL(url); // Validate URL format
            } catch (_) {
                showMessage('Please enter a valid URL format (e.g., https://...).', 'error');
                return;
            }

            if (id) { // Editing existing
                const index = favorites.findIndex(s => s.id.toString() === id);
                if (index > -1) {
                    favorites[index] = { ...favorites[index], name, url };
                    showMessage('Station updated successfully!', 'success');
                    saveFavorites();
                    
                    // Update current playing station if it's the one being edited
                    if (currentPlayingStation && currentPlayingStation.id === id) {
                        currentPlayingStation = { ...currentPlayingStation, name, url };
                        currentStationName.textContent = name;
                        currentStationNameCompact.textContent = name;
                    }
                }
            } else { // Adding new
                if (favorites.some(fav => fav.url === url)) {
                    showMessage('This station URL is already in your favorites.', 'info');
                    closeModal();
                    return;
                }
                
                const newStation = { id: Date.now().toString(), name, url };
                favorites.push(newStation);
                showMessage('Station added to favorites!', 'success');
                saveFavorites();
                
                // If the newly added station is the one currently playing from a direct URL
                if (currentPlayingStation && currentPlayingStation.url === url && isDirectUrlStream) {
                    isDirectUrlStream = false;
                    addCurrentToFavoritesBtn.classList.add('hidden');
                    currentPlayingStation = newStation;
                }
            }
            
            closeModal();
        });

        function deleteFavorite(id) {
            const stationToDelete = favorites.find(s => s.id === id);
            const isPlaying = currentPlayingStation && stationToDelete && currentPlayingStation.url === stationToDelete.url;
            
            // Create a custom confirmation modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-60 dark:bg-opacity-75 flex items-center justify-center p-4 z-[100]';
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold mb-4">Delete Station</h3>
                    <p class="mb-6">Are you sure you want to delete "${stationToDelete.name}"?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDeleteBtn" class="btn-secondary">Cancel</button>
                        <button id="confirmDeleteBtn" class="btn-danger">Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const cancelBtn = modal.querySelector('#cancelDeleteBtn');
            const confirmBtn = modal.querySelector('#confirmDeleteBtn');
            
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            confirmBtn.addEventListener('click', () => {
                favorites = favorites.filter(s => s.id !== id);
                
                // Also remove from quick access if it's there
                quickAccessStations = quickAccessStations.filter(q => q.url !== stationToDelete.url);
                localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
                
                saveFavorites();
                showMessage('Station deleted.', 'info');
                
                if (isPlaying) {
                    stopPlayback();
                }
                
                document.body.removeChild(modal);
            });
        }

        // --- Import/Export Functions ---
        importFavoritesBtn.addEventListener('click', () => {
            fileImportInput.click();
        });

        exportFavoritesBtn.addEventListener('click', exportFavorites);
        
        clearFavoritesBtn.addEventListener('click', () => {
            if (favorites.length === 0) {
                showMessage('No favorites to clear.', 'info');
                return;
            }
            openClearConfirmModal();
        });

        fileImportInput.addEventListener('change', handleFileImport);

        cancelImportBtn.addEventListener('click', closeImportConfirmModal);
        confirmImportBtn.addEventListener('click', confirmImport);
        
        cancelClearBtn.addEventListener('click', closeClearConfirmModal);
        confirmClearBtn.addEventListener('click', confirmClearFavorites);

       async function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.lbrx')) {
        showMessage('Please select a .lbrx file for import.', 'error');
        return; // REMOVED fileInput.value clearing
    }

    try {
        const content = await readFileAsText(file);
        const importedStations = parseLBRXFile(content);
        
        if (importedStations.length === 0) {
            showMessage('No valid stations found in the import file.', 'info');
            return;
        }

        // STORE THE FILE REFERENCE
        window.pendingImportFile = file; // NEW LINE
        openImportConfirmModal(importedStations.length);
        
    } catch (error) {
        console.error('Import error:', error);
        showMessage('Failed to read file: ' + error.message, 'error');
    }
}

function confirmImport() {
    // USE THE STORED FILE REFERENCE
    const file = window.pendingImportFile || fileImportInput.files[0];
    
    if (!file) {
        showMessage('No file selected', 'error');
        return;
    }

    readFileAsText(file)
        .then(content => {
            const importedStations = parseLBRXFile(content);
            
            // SIMPLE MERGE LOGIC
            importedStations.forEach(newStation => {
                if (!favorites.some(s => s.url === newStation.url)) {
                    favorites.push(newStation);
                }
            });
            
            // FORCE UPDATE
            localStorage.setItem('radioFavorites', JSON.stringify(favorites));
            renderFavorites();
            updateFavoritesCount();
            
            showMessage(`Imported ${importedStations.length} stations!`, 'success');
        })
        .catch(error => {
            showMessage('Import failed: ' + error.message, 'error');
        })
        .finally(() => {
            closeImportConfirmModal();
            fileImportInput.value = ''; // Clear here instead
            delete window.pendingImportFile; // Clean up
        });
}

        function confirmClearFavorites() {
            favorites = [];
            quickAccessStations = defaultQuickAccessStations; // Reset to defaults
            localStorage.setItem('quickAccessStations', JSON.stringify(quickAccessStations));
            saveFavorites();
            showMessage('All favorites cleared and Quick Access reset.', 'info');
            closeClearConfirmModal();
            
            if (currentPlayingStation) {
                stopPlayback();
            }
        }

        function exportFavorites() {
            if (favorites.length === 0) {
                showMessage('No favorites to export.', 'info');
                return;
            }

            const lbrxContent = generateLBRXContent();
            const blob = new Blob([lbrxContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentLbrxFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage(`Favorites exported to ${currentLbrxFileName}!`, 'success');
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('File reading failed'));
                reader.readAsText(file);
            });
        }

    function parseLBRXFile(content) {
    const stations = [];
    const lines = content.split('\n');
    let currentStation = null;
    let inStationsSection = false;

    for (const line of lines) {
        const trimmed = line.trim();
        
        // Skip empty lines and comments
        if (!trimmed || trimmed.startsWith('##')) continue;
        
        // Detect stations section
        if (trimmed.includes('FAVORITE STATIONS')) {
            inStationsSection = true;
            continue;
        }
        
        // Skip section end markers
        if (trimmed.startsWith('===')) continue;

        if (inStationsSection) {
            // Check if line looks like a URL
            if (trimmed.match(/^https?:\/\//i)) {
                if (currentStation) {
                    currentStation.url = trimmed;
                    
                    // Validate URL
                    try {
                        new URL(currentStation.url);
                        stations.push(currentStation);
                    } catch (e) {
                        console.warn('Invalid URL skipped:', currentStation.url);
                    }
                    currentStation = null;
                }
            } 
            // Otherwise treat as station name (clean up numbering)
            else if (!currentStation) {
                const cleanName = trimmed
                    .replace(/^\d+\.\s*/, '')  // Remove leading "1. "
                    .replace(/^\d+\.\w+\s*-\s*/i, '');  // Remove "1.FM - "
                
                currentStation = {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 5),
                    name: cleanName,
                    url: ''
                };
            }
        }
    }
    
    console.log('Parsed stations:', stations);
    return stations;
}

        function processImportedStations(importedStations) {
            const results = {
                added: 0,
                skipped: 0,
                updated: 0
            };
            
            for (const imported of importedStations) {
                const existingByUrl = favorites.find(f => f.url === imported.url);
                
                if (existingByUrl) {
                    if (existingByUrl.name !== imported.name) {
                        existingByUrl.name = imported.name;
                        results.updated++;
                    } else {
                        results.skipped++;
                    }
                    continue;
                }
                
                const existingByName = favorites.find(f => f.name === imported.name);
                if (existingByName) {
                    results.skipped++;
                    continue;
                }
                
                favorites.push(imported);
                results.added++;
            }
            
            return results;
        }

        function showImportResults(results) {
            let message = '';
            
            if (results.added > 0) {
                message += `Added ${results.added} new stations. `;
            }
            if (results.updated > 0) {
                message += `Updated ${results.updated} existing stations. `;
            }
            if (results.skipped > 0) {
                message += `Skipped ${results.skipped} duplicates.`;
            }
            
            showMessage(message.trim(), 'success', 5000);
        }

        // --- Audio Player Logic ---
        function playStation(station, isDirect = false) {
            try {
                if (!station || !station.url) {
                    showMessage('Invalid station data.', 'error');
                    return;
                }

                // Stop any current playback
                stopPlayback();
                
                // Setup audio context for visualization if not already done
                setupAudioContext();
                
                // Enable CORS mode
                audioPlayer.crossOrigin = "anonymous";
                
                // Create a clean URL with cache busting
                let streamUrl = station.url;
                
                // Show loading state
                currentStationName.textContent = 'Loading...';
                currentStationNameCompact.textContent = 'Loading...';
                playPauseBtn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
                
                // 1. First try direct play (works for CORS-enabled streams)
                audioPlayer.src = streamUrl + (streamUrl.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
                
                audioPlayer.play()
                    .then(() => {
                        // Success case
                        currentPlayingStation = station;
                        currentStationName.textContent = station.name;
                        currentStationNameCompact.textContent = station.name;
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                        playPauseBtn.setAttribute('aria-label', 'Pause');
                        nowPlayingSection.classList.remove('hidden');

                        isDirectUrlStream = isDirect;
                        const isAlreadyFavorite = favorites.some(fav => fav.url === station.url);

              // Show/hide the add to favorites button
if (isDirect && !isAlreadyFavorite) {
    addCurrentToFavoritesBtn.classList.remove('hidden');
    addCurrentToFavoritesBtn.innerHTML = '<i class="fas fa-star"></i>';
    addCurrentToFavoritesBtn.title = 'Add current station to favorites';
} else if (!isDirect && isAlreadyFavorite) {
    addCurrentToFavoritesBtn.classList.add('hidden');
} else {
    addCurrentToFavoritesBtn.classList.add('hidden');
}
                        
                        // Start bitrate monitoring
                        startBitrateMonitoring();
                        
                        // Update UI to show playing state
                        renderFavorites();
                    })
                    .catch(error => {
                        console.error("Direct play failed, trying proxy:", error);
                        
                        // 2. Fallback to CORS proxy
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(streamUrl)}`;
                        audioPlayer.src = proxyUrl;
                        
                        return audioPlayer.play().then(() => {
                            // Proxy success
                            currentPlayingStation = station;
                            currentStationName.textContent = station.name + " (via proxy)";
                            currentStationNameCompact.textContent = station.name + " (proxy)";
                            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                            nowPlayingSection.classList.remove('hidden');
                            
                            // Start bitrate monitoring
                            startBitrateMonitoring();
                            
                            // Update UI to show playing state
                            renderFavorites();
                        }).catch(proxyError => {
                            // Final failure
                            console.error("Proxy playback failed:", proxyError);
                            showMessage(`Cannot play: ${station.name}. Try another stream.`, 'error');
                            currentStationName.textContent = "Playback Error";
                            currentStationNameCompact.textContent = "Error";
                            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                            nowPlayingSection.classList.add('hidden');
                            stopBitrateMonitoring();
                        });
                    });
            } catch (error) {
                console.error("Setup error:", error);
                showMessage(`Error with station: ${station.name}`, 'error');
                addCurrentToFavoritesBtn.classList.add('hidden');
                nowPlayingSection.classList.add('hidden');
                stopBitrateMonitoring();
            }
        }
        
        function setupAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 32;
                    
                    const source = audioContext.createMediaElementSource(audioPlayer);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination);
                } catch (e) {
                    console.warn('Web Audio API not supported:', e);
                }
            }
        }
        
        function startBitrateMonitoring() {
            stopBitrateMonitoring();
            lastBytes = 0;
            bitrateInterval = setInterval(updateBitrateInfo, 2000);
        }
        
        function stopBitrateMonitoring() {
            if (bitrateInterval) {
                clearInterval(bitrateInterval);
                bitrateInterval = null;
            }
            bitrateInfo.textContent = '';
        }
        
        function updateBitrateInfo() {
            if (audioPlayer.buffered.length > 0) {
                const bytesLoaded = audioPlayer.buffered.end(0) * audioPlayer.duration * 1000;
                const bytesDiff = bytesLoaded - lastBytes;
                const bitrate = Math.round((bytesDiff * 8) / 2000); // kbps
                
                if (bitrate > 0) {
                    bitrateInfo.textContent = `${bitrate} kbps`;
                }
                
                lastBytes = bytesLoaded;
            }
        }
        
        // Event listener for playDirectUrlBtn
        playDirectUrlBtn.addEventListener('click', () => {
            const url = directUrlInput.value.trim();
            if (url) {
                try {
                    new URL(url);
                } catch (_) {
                    showMessage('Please enter a valid stream URL format (e.g., https://...).', 'error');
                    return;
                }

                let name = "Direct Stream";
                try {
                    const urlObj = new URL(url);
                    name = urlObj.hostname.replace(/^www\./, '') || "Direct Stream";
                } catch (e) { /* ignore if URL is not standard for hostname extraction */ }

                playStation({ id: 'direct_' + Date.now(), name: name, url: url }, true);
            } else {
                showMessage('Please enter a stream URL.', 'error');
            }
        });

        function togglePlayPause() {
            if (!currentPlayingStation && favorites.length > 0) {
                playStation(favorites[0], false);
                return;
            }
            if (!currentPlayingStation) {
                showMessage('No station selected to play.', 'info');
                return;
            }

            if (audioPlayer.paused) {
                audioPlayer.play().catch(e => {
                    showMessage('Error resuming playback.', 'error');
                    console.error("Play error:", e);
                });
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'Pause');
            } else {
                audioPlayer.pause();
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
            }
            
            renderFavorites();
        }

        function stopPlayback() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            if (audioPlayer.src) audioPlayer.src = "";
            
            currentPlayingStation = null;
            isDirectUrlStream = false;
            currentStationName.textContent = '---';
            currentStationNameCompact.textContent = '---';
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            addCurrentToFavoritesBtn.classList.add('hidden');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        }

       function addCurrentToFavorites() {
    if (!currentPlayingStation || !currentPlayingStation.url) {
        showMessage('No station currently playing to add to favorites.', 'info');
        return;
    }
    
    // Check if already in favorites
    const isAlreadyFavorite = favorites.some(fav => fav.url === currentPlayingStation.url);
    if (isAlreadyFavorite) {
        showMessage('This station is already in your favorites!', 'info');
        return;
    }
    
    // Generate a name if it's a direct URL stream
    let name = currentPlayingStation.name;
    if (isDirectUrlStream && name === "Direct Stream") {
        try {
            const urlObj = new URL(currentPlayingStation.url);
            name = urlObj.hostname.replace(/^www\./, '') || "Custom Station";
        } catch (e) {
            name = "Custom Station";
        }
    }
    
    // Open the add modal with the current station's info
    openModal('add', {
        name: name,
        url: currentPlayingStation.url
    });
    
    // Hide the button since we're adding it to favorites
    addCurrentToFavoritesBtn.classList.add('hidden');
}

        playPauseBtn.addEventListener('click', togglePlayPause);
        stopBtn.addEventListener('click', stopPlayback);
       addCurrentToFavoritesBtn.addEventListener('click', addCurrentToFavorites);

        volumeControl.addEventListener('input', (e) => {
            audioPlayer.volume = parseFloat(e.target.value);
        });
        audioPlayer.volume = parseFloat(volumeControl.value);

        audioPlayer.addEventListener('error', (e) => {
            console.error('Audio Player Error Event:', e);
            let errorMessage = "Error playing audio.";
            if (currentPlayingStation) {
                errorMessage = `Playback error for: ${currentPlayingStation.name}. The stream might be offline or the URL incorrect.`;
            }
            showMessage(errorMessage, 'error', 5000);
            currentStationName.textContent = "Playback Error";
            currentStationNameCompact.textContent = "Error";
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        });

        audioPlayer.addEventListener('ended', () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'Play');
            showMessage('Stream ended or was interrupted.', 'info');
            nowPlayingSection.classList.add('hidden');
            stopBitrateMonitoring();
            
            renderFavorites();
        });
        
        audioPlayer.onplaying = () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'Pause');
            nowPlayingSection.classList.remove('hidden');
            
            renderFavorites();
        };
        
        audioPlayer.onpause = () => {
            if (audioPlayer.readyState > 0 && !audioPlayer.error && audioPlayer.currentTime > 0) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
                
                renderFavorites();
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            switch(e.key) {
                case ' ':
                    e.preventDefault();
                    togglePlayPause();
                    break;
                case 's':
                case 'S':
                    e.preventDefault();
                    stopPlayback();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    volumeControl.stepUp();
                    audioPlayer.volume = parseFloat(volumeControl.value);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    volumeControl.stepDown();
                    audioPlayer.volume = parseFloat(volumeControl.value);
                    break;
            }
        });

        // --- Initial Load ---

document.addEventListener('DOMContentLoaded', () => {
    loadTheme();
    loadFavorites();
    initializeRadioBrowser(); // Add this line
    
    if (audioPlayer.paused) {
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.setAttribute('aria-label', 'Play');
    } else {
        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
        playPauseBtn.setAttribute('aria-label', 'Pause');
    }
    messageBox.classList.add('opacity-0', 'invisible', 'hidden');
});
       
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            loadFavorites();
            if (audioPlayer.paused) {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'Play');
            } else {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'Pause');
            }
            messageBox.classList.add('opacity-0', 'invisible', 'hidden');
        });

        // PWA Installation
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('ServiceWorker registered'))
                    .catch(err => console.log('ServiceWorker failed: ', err));
            });
        }

        // Install Prompt Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            console.log('PWA installable');
            window.deferredInstallPrompt = e;
            
            const installButton = document.getElementById('installButton');
            if (installButton) {
                installButton.classList.remove('hidden');
                installButton.addEventListener('click', () => {
                    e.prompt();
                    e.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted install');
                            installButton.classList.add('hidden');
                        } else {
                            console.log('User dismissed install');
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
